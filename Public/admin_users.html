<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Users - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="admin_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="admin_users.html" class="active"><span class="nav-icon"><i class="fas fa-users-cog"></i></span><span class="nav-text">User Management</span></a></li>
                <li><a href="admin_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="admin_settings.html"><span class="nav-icon"><i class="fas fa-cogs"></i></span><span class="nav-text">Settings</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>User Management System</h2>
                <p class="dashboard-subtitle">Comprehensive user administration and role management</p>
            </div>

            <!-- User Statistics -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <p id="totalStudents">245</p>
                        <small class="stat-change positive">+8 this month</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-nurse"></i></div>
                    <div class="stat-content">
                        <h3>Active Nurses</h3>
                        <p id="activeNurses">12</p>
                        <small class="stat-change neutral">No change</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="stat-content">
                        <h3>Administrators</h3>
                        <p id="totalAdmins">3</p>
                        <small class="stat-change neutral">No change</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-clock"></i></div>
                    <div class="stat-content">
                        <h3>Pending Approvals</h3>
                        <p id="pendingUsers">5</p>
                        <small class="stat-change warning">Requires attention</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-user-plus"></i></div>
                    <h3>Add New User</h3>
                    <p>Create new student, nurse, or admin accounts</p>
                    <button class="btn-primary" onclick="showAddUserModal()">Add User</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-upload"></i></div>
                    <h3>Bulk Import</h3>
                    <p>Import users from CSV or Excel files</p>
                    <button class="btn-primary" onclick="showBulkImportModal()">Import Users</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-key"></i></div>
                    <h3>Reset Passwords</h3>
                    <p>Reset passwords for multiple users</p>
                    <button class="btn-primary" onclick="showPasswordResetModal()">Reset Passwords</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file-export"></i></div>
                    <h3>Export Users</h3>
                    <p>Export user data for backup or analysis</p>
                    <button class="btn-primary" onclick="exportUsers()">Export Data</button>
                </div>
            </div>

            <!-- User Management Tabs -->
            <div class="user-management">
                <div class="user-tabs">
                    <button class="tab-btn active" onclick="showTab('students')">
                        <i class="fas fa-graduation-cap"></i> Students
                    </button>
                    <button class="tab-btn" onclick="showTab('nurses')">
                        <i class="fas fa-user-nurse"></i> Nurses
                    </button>
                    <button class="tab-btn" onclick="showTab('admins')">
                        <i class="fas fa-user-shield"></i> Administrators
                    </button>
                    <button class="tab-btn" onclick="showTab('pending')">
                        <i class="fas fa-clock"></i> Pending Approval
                    </button>
                </div>

                <!-- Students Tab -->
                <div class="user-list active" id="studentsTab">
                    <div class="list-header">
                        <h3>Student Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="studentSearch" placeholder="Search students..." class="search-input">
                            <select id="studentFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Student ID</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                    <div id="studentsPagination" class="pagination-container" style="display: none;">
                        <button id="studentsPrevPage" class="btn-secondary">Previous</button>
                        <span id="studentsPageInfo">Page 1 of 1</span>
                        <button id="studentsNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Nurses Tab -->
                <div class="user-list" id="nursesTab">
                    <div class="list-header">
                        <h3>Nurse Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="nurseSearch" placeholder="Search nurses..." class="search-input">
                            <select id="nurseFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="on-leave">On Leave</option>
                            </select>
                        </div>
                    </div>
                    <table id="nursesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Employee ID</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Nurses will be loaded here -->
                        </tbody>
                    </table>
                    <div id="nursesPagination" class="pagination-container" style="display: none;">
                        <button id="nursesPrevPage" class="btn-secondary">Previous</button>
                        <span id="nursesPageInfo">Page 1 of 1</span>
                        <button id="nursesNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Admins Tab -->
                <div class="user-list" id="adminsTab">
                    <div class="list-header">
                        <h3>Administrator Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="adminSearch" placeholder="Search admins..." class="search-input">
                            <select id="adminFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <table id="adminsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Admin ID</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Admins will be loaded here -->
                        </tbody>
                    </table>
                    <div id="adminsPagination" class="pagination-container" style="display: none;">
                        <button id="adminsPrevPage" class="btn-secondary">Previous</button>
                        <span id="adminsPageInfo">Page 1 of 1</span>
                        <button id="adminsNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Pending Tab -->
                <div class="user-list" id="pendingTab">
                    <div class="list-header">
                        <h3>Pending User Approvals</h3>
                        <div class="list-stats">
                            <span id="pendingCount">5</span> users awaiting approval
                        </div>
                    </div>
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pending users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Detail Modal -->
            <div id="userModal" class="modal" style="display: none;">
                <div class="modal-content large-modal">
                    <div class="modal-header">
                        <h3 id="modalTitle">User Details</h3>
                        <button class="btn-close" onclick="closeUserModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div id="userDetailContent">
                        <!-- User details will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Tab functionality
        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.user-list');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');

            // Load data for the selected tab
            loadTabData(tabName);
        }

        // Load data for specific tabs
        function loadTabData(tabName) {
            const page = currentPages[tabName] || 1;
            switch(tabName) {
                case 'students':
                    loadStudents('', page);
                    break;
                case 'nurses':
                    loadNurses('', page);
                    break;
                case 'admins':
                    loadAdmins('', page);
                    break;
                case 'pending':
                    loadPendingUsers(page);
                    break;
            }
        }

        // Load students data
        async function loadStudents(search = '', page = 1) {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'student',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetch(`${API_BASE_URL}/admin/users?${params}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    displayStudents(result.users);
                    updatePagination(result.pagination, 'students');
                } else {
                    showError(result.message || 'Failed to load students');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading students</td></tr>';
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading students</td></tr>';
            }
        }

        function displayStudents(students) {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No students found</td></tr>';
                return;
            }

            students.forEach(student => {
                const fullName = `${student.first_name} ${student.middle_name || ''} ${student.last_name} ${student.extension_name || ''}`.trim();
                const statusBadge = student.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${student.role_specific_id || student.ctu_id || 'N/A'}</td>
                    <td>${student.email}</td>
                    <td>${student.department || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(student.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${student.id})">View</button>
                        <button class="btn-small" onclick="editUser(${student.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${student.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load nurses data
        async function loadNurses(search = '', page = 1) {
            const tbody = document.querySelector('#nursesTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'nurse',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetch(`${API_BASE_URL}/admin/users?${params}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    displayNurses(result.users);
                    updatePagination(result.pagination, 'nurses');
                } else {
                    showError(result.message || 'Failed to load nurses');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading nurses</td></tr>';
                }
            } catch (error) {
                console.error('Error loading nurses:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading nurses</td></tr>';
            }
        }

        function displayNurses(nurses) {
            const tbody = document.querySelector('#nursesTable tbody');
            tbody.innerHTML = '';

            if (nurses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No nurses found</td></tr>';
                return;
            }

            nurses.forEach(nurse => {
                const fullName = `${nurse.first_name} ${nurse.middle_name || ''} ${nurse.last_name} ${nurse.extension_name || ''}`.trim();
                const statusBadge = nurse.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${nurse.role_specific_id || nurse.ctu_id || 'N/A'}</td>
                    <td>${nurse.email}</td>
                    <td>${nurse.specialization || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(nurse.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${nurse.id})">View</button>
                        <button class="btn-small" onclick="editUser(${nurse.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${nurse.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load admins data
        async function loadAdmins(search = '', page = 1) {
            const tbody = document.querySelector('#adminsTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'admin',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetch(`${API_BASE_URL}/admin/users?${params}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    displayAdmins(result.users);
                    updatePagination(result.pagination, 'admins');
                } else {
                    showError(result.message || 'Failed to load admins');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading admins</td></tr>';
                }
            } catch (error) {
                console.error('Error loading admins:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading admins</td></tr>';
            }
        }

        function displayAdmins(admins) {
            const tbody = document.querySelector('#adminsTable tbody');
            tbody.innerHTML = '';

            if (admins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No admins found</td></tr>';
                return;
            }

            admins.forEach(admin => {
                const fullName = `${admin.first_name} ${admin.middle_name || ''} ${admin.last_name} ${admin.extension_name || ''}`.trim();
                const statusBadge = admin.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${admin.ctu_id || 'N/A'}</td>
                    <td>${admin.email}</td>
                    <td>Administrator</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(admin.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${admin.id})">View</button>
                        <button class="btn-small" onclick="editUser(${admin.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${admin.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load pending users (users who haven't confirmed email)
        async function loadPendingUsers(page = 1) {
            const tbody = document.querySelector('#pendingTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading...</td></tr>';

            try {
                // For pending users, we might need a different endpoint or filter
                // For now, we'll load all users and filter client-side, or modify backend
                const response = await fetch(`${API_BASE_URL}/admin/users?page=${page}&limit=50`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    // Filter users who haven't confirmed email
                    const pendingUsers = result.users.filter(user => !user.is_email_confirmed);
                    displayPendingUsers(pendingUsers);

                    // Update pending count
                    document.getElementById('pendingCount').textContent = pendingUsers.length;
                } else {
                    showError(result.message || 'Failed to load pending users');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading pending users</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pending users:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading pending users</td></tr>';
            }
        }

        function displayPendingUsers(users) {
            const tbody = document.querySelector('#pendingTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pending users</td></tr>';
                return;
            }

            users.forEach(user => {
                const fullName = `${user.first_name} ${user.middle_name || ''} ${user.last_name} ${user.extension_name || ''}`.trim();
                const roleDisplay = user.role.charAt(0).toUpperCase() + user.role.slice(1);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${user.email}</td>
                    <td>${roleDisplay}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small btn-success" onclick="approveUser(${user.id})">Approve</button>
                        <button class="btn-small btn-danger" onclick="rejectUser(${user.id})">Reject</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // User action functions
        async function viewUser(userId) {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    // Show user details in modal
                    displayUserDetails(result);
                    document.getElementById('userModal').style.display = 'block';
                } else {
                    showError(result.message || 'Failed to load user details');
                }
            } catch (error) {
                console.error('Error viewing user:', error);
                showError('Network error. Please try again.');
            }
        }

        async function editUser(userId) {
            // For now, redirect to a user edit page or show edit modal
            // This would need additional implementation
            alert(`Edit functionality for user ${userId} - needs implementation`);
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User deleted successfully');
                    // Reload current tab data
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        const tabName = activeTab.textContent.toLowerCase().replace(' ', '');
                        loadTabData(tabName + 's'); // students, nurses, admins
                    }
                    loadStatistics(); // Update stats
                } else {
                    showError(result.message || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Network error. Please try again.');
            }
        }

        async function approveUser(userId) {
            if (!confirm('Approve this user registration?')) {
                return;
            }

            try {
                // Approve by setting is_email_confirmed to true
                const response = await fetch(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ isEmailConfirmed: true })
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User approved successfully');
                    loadPendingUsers(); // Reload pending users
                    loadStatistics(); // Update stats
                } else {
                    showError(result.message || 'Failed to approve user');
                }
            } catch (error) {
                console.error('Error approving user:', error);
                showError('Network error. Please try again.');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Reject this user registration? The user account will be deleted.')) {
                return;
            }

            // Reject by deleting the user
            await deleteUser(userId);
        }

        function displayUserDetails(user) {
            const fullName = `${user.first_name} ${user.middle_name || ''} ${user.last_name} ${user.extension_name || ''}`.trim();

            const detailsHtml = `
                <div class="user-details">
                    <div class="detail-row">
                        <strong>Name:</strong> ${fullName}
                    </div>
                    <div class="detail-row">
                        <strong>Email:</strong> ${user.email}
                    </div>
                    <div class="detail-row">
                        <strong>Role:</strong> ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                    </div>
                    <div class="detail-row">
                        <strong>ID:</strong> ${user.ctu_id || 'N/A'}
                    </div>
                    <div class="detail-row">
                        <strong>Phone:</strong> ${user.contact_number || 'N/A'}
                    </div>
                    <div class="detail-row">
                        <strong>Email Confirmed:</strong> ${user.is_email_confirmed ? 'Yes' : 'No'}
                    </div>
                    <div class="detail-row">
                        <strong>Created:</strong> ${new Date(user.created_at).toLocaleDateString()}
                    </div>
                    ${user.role === 'student' ? `
                        <div class="detail-row">
                            <strong>School Year:</strong> ${user.school_year || 'N/A'}
                        </div>
                        <div class="detail-row">
                            <strong>School Level:</strong> ${user.school_level || 'N/A'}
                        </div>
                        <div class="detail-row">
                            <strong>Department:</strong> ${user.department || 'N/A'}
                        </div>
                    ` : ''}
                    ${user.role === 'nurse' ? `
                        <div class="detail-row">
                            <strong>License Number:</strong> ${user.role_specific_id || 'N/A'}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('userDetailContent').innerHTML = detailsHtml;
        }

        function showAddUserModal() {
            alert('Add user modal coming soon!');
        }

        function showBulkImportModal() {
            alert('Bulk import modal coming soon!');
        }

        function showPasswordResetModal() {
            alert('Password reset modal coming soon!');
        }

        function exportUsers() {
            alert('Export functionality coming soon!');
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetch(`${API_BASE_URL}/admin/statistics`, {
                    credentials: 'include'
                });

                const result = await response.json();

                if (response.ok) {
                    // Update statistics cards
                    const userStats = result.userStats || [];
                    const studentStat = userStats.find(stat => stat.role === 'student') || { count: 0 };
                    const nurseStat = userStats.find(stat => stat.role === 'nurse') || { count: 0 };
                    const adminStat = userStats.find(stat => stat.role === 'admin') || { count: 0 };

                    document.getElementById('totalStudents').textContent = studentStat.count;
                    document.getElementById('activeNurses').textContent = nurseStat.count;
                    document.getElementById('totalAdmins').textContent = adminStat.count;

                    // For pending users, count users with unconfirmed emails
                    // This could be improved by adding a specific endpoint
                    document.getElementById('pendingUsers').textContent = '0'; // Placeholder
                } else {
                    console.error('Failed to load statistics:', result.message);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Search and filter functionality
        function initializeSearchAndFilters() {
            // Student search
            const studentSearch = document.getElementById('studentSearch');
            if (studentSearch) {
                let studentSearchTimeout;
                studentSearch.addEventListener('input', function() {
                    clearTimeout(studentSearchTimeout);
                    studentSearchTimeout = setTimeout(() => {
                        currentPages.students = 1; // Reset to page 1 on search
                        loadStudents(this.value, 1);
                    }, 500);
                });
            }

            // Nurse search
            const nurseSearch = document.getElementById('nurseSearch');
            if (nurseSearch) {
                let nurseSearchTimeout;
                nurseSearch.addEventListener('input', function() {
                    clearTimeout(nurseSearchTimeout);
                    nurseSearchTimeout = setTimeout(() => {
                        currentPages.nurses = 1; // Reset to page 1 on search
                        loadNurses(this.value, 1);
                    }, 500);
                });
            }

            // Admin search
            const adminSearch = document.getElementById('adminSearch');
            if (adminSearch) {
                let adminSearchTimeout;
                adminSearch.addEventListener('input', function() {
                    clearTimeout(adminSearchTimeout);
                    adminSearchTimeout = setTimeout(() => {
                        currentPages.admins = 1; // Reset to page 1 on search
                        loadAdmins(this.value, 1);
                    }, 500);
                });
            }
        }

        // Pagination state
        let currentPages = {
            students: 1,
            nurses: 1,
            admins: 1,
            pending: 1
        };

        // Pagination function
        function updatePagination(pagination, type) {
            const paginationContainer = document.getElementById(`${type}Pagination`);
            const pageInfo = document.getElementById(`${type}PageInfo`);
            const prevBtn = document.getElementById(`${type}PrevPage`);
            const nextBtn = document.getElementById(`${type}NextPage`);

            if (pagination.pages > 1) {
                paginationContainer.style.display = 'flex';
                pageInfo.textContent = `Page ${pagination.page} of ${pagination.pages}`;

                // Update button states
                prevBtn.disabled = pagination.page <= 1;
                nextBtn.disabled = pagination.page >= pagination.pages;

                // Add event listeners if not already added
                if (!prevBtn.hasEventListener) {
                    prevBtn.addEventListener('click', () => changePage(type, pagination.page - 1));
                    nextBtn.addEventListener('click', () => changePage(type, pagination.page + 1));
                    prevBtn.hasEventListener = true;
                    nextBtn.hasEventListener = true;
                }
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function changePage(type, page) {
            currentPages[type] = page;
            const searchInput = document.getElementById(`${type.slice(0, -1)}Search`); // Remove 's' from end
            const searchValue = searchInput ? searchInput.value : '';

            switch(type) {
                case 'students':
                    loadStudents(searchValue, page);
                    break;
                case 'nurses':
                    loadNurses(searchValue, page);
                    break;
                case 'admins':
                    loadAdmins(searchValue, page);
                    break;
                case 'pending':
                    loadPendingUsers(page);
                    break;
            }
        }

        // Load initial data
        loadStatistics();
        initializeSearchAndFilters();
        loadStudents();
    </script>
</body>
</html>