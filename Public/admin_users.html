<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Users - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>CTU Bantayan E-Clinic</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="admin_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="admin_users.html" class="active"><span class="nav-icon"><i class="fas fa-users-cog"></i></span><span class="nav-text">User Management</span></a></li>
                <li><a href="admin_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="admin_settings.html"><span class="nav-icon"><i class="fas fa-cogs"></i></span><span class="nav-text">Settings</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>User Management System</h2>
                <p class="dashboard-subtitle">Comprehensive user administration and role management</p>
            </div>

            <!-- User Statistics -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-graduation-cap"></i></div>
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <p id="totalStudents">...</p>
                        <small class="stat-change positive">Campus-wide</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-nurse"></i></div>
                    <div class="stat-content">
                        <h3>Active Nurses</h3>
                        <p id="activeNurses">...</p>
                        <small class="stat-change neutral">On duty</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-shield"></i></div>
                    <div class="stat-content">
                        <h3>Administrators</h3>
                        <p id="totalAdmins">...</p>
                        <small class="stat-change neutral">System-wide</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-user-clock"></i></div>
                    <div class="stat-content">
                        <h3>Pending Approvals</h3>
                        <p id="pendingUsers">...</p>
                        <small class="stat-change warning">Requires attention</small>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-grid">
                <div class="dashboard-card primary-action-card">
                    <div class="card-icon"><i class="fas fa-user-plus"></i></div>
                    <h3>Add New User</h3>
                    <p>Create new student, nurse, or admin accounts</p>
                    <button class="btn-primary" onclick="showAddUserModal()">Add User</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-upload"></i></div>
                    <h3>Bulk Import</h3>
                    <p>Import users from CSV or Excel files</p>
                    <button class="btn-primary" onclick="showBulkImportModal()">Import Users</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-key"></i></div>
                    <h3>Reset Passwords</h3>
                    <p>Reset passwords for multiple users</p>
                    <button class="btn-primary" onclick="showPasswordResetModal()">Reset Passwords</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file-export"></i></div>
                    <h3>Export Users</h3>
                    <p>Export user data for backup or analysis</p>
                    <button class="btn-primary" onclick="exportUsers()">Export Data</button>
                </div>
            </div>

            <!-- User Management Tabs -->
            <div class="user-management">
                <div class="user-tabs">
                    <button class="tab-btn active" onclick="showTab(this, 'students')">
                        <i class="fas fa-graduation-cap"></i> Students
                    </button>
                    <button class="tab-btn" onclick="showTab(this, 'nurses')">
                        <i class="fas fa-user-nurse"></i> Nurses
                    </button>
                    <button class="tab-btn" onclick="showTab(this, 'admins')">
                        <i class="fas fa-user-shield"></i> Administrators
                    </button>
                    <button class="tab-btn" onclick="showTab(this, 'pending')">
                        <i class="fas fa-clock"></i> Pending Approval
                    </button>
                </div>

                <!-- Students Tab -->
                <div class="user-list active" id="studentsTab">
                    <div class="list-header">
                        <h3>Student Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="studentSearch" placeholder="Search students..." class="search-input">
                            <select id="studentFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="suspended">Suspended</option>
                            </select>
                        </div>
                    </div>
                    <table id="studentsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Student ID</th>
                                <th>Email</th>
                                <th>Program</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Students will be loaded here -->
                        </tbody>
                    </table>
                    <div id="studentsPagination" class="pagination-container" style="display: none;">
                        <button id="studentsPrevPage" class="btn-secondary">Previous</button>
                        <span id="studentsPageInfo">Page 1 of 1</span>
                        <button id="studentsNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Nurses Tab -->
                <div class="user-list" id="nursesTab">
                    <div class="list-header">
                        <h3>Nurse Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="nurseSearch" placeholder="Search nurses..." class="search-input">
                            <select id="nurseFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                                <option value="on-leave">On Leave</option>
                            </select>
                        </div>
                    </div>
                    <table id="nursesTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Employee ID</th>
                                <th>Email</th>
                                <th>Specialization</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Nurses will be loaded here -->
                        </tbody>
                    </table>
                    <div id="nursesPagination" class="pagination-container" style="display: none;">
                        <button id="nursesPrevPage" class="btn-secondary">Previous</button>
                        <span id="nursesPageInfo">Page 1 of 1</span>
                        <button id="nursesNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Admins Tab -->
                <div class="user-list" id="adminsTab">
                    <div class="list-header">
                        <h3>Administrator Accounts</h3>
                        <div class="list-actions">
                            <input type="text" id="adminSearch" placeholder="Search admins..." class="search-input">
                            <select id="adminFilter" class="filter-select">
                                <option value="">All Status</option>
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>
                    </div>
                    <table id="adminsTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Admin ID</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Admins will be loaded here -->
                        </tbody>
                    </table>
                    <div id="adminsPagination" class="pagination-container" style="display: none;">
                        <button id="adminsPrevPage" class="btn-secondary">Previous</button>
                        <span id="adminsPageInfo">Page 1 of 1</span>
                        <button id="adminsNextPage" class="btn-secondary">Next</button>
                    </div>
                </div>

                <!-- Pending Tab -->
                <div class="user-list" id="pendingTab">
                    <div class="list-header">
                        <h3>Pending User Approvals</h3>
                        <div class="list-stats">
                            <span id="pendingCount">5</span> users awaiting approval
                        </div>
                    </div>
                    <table id="pendingTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Role</th>
                                <th>Registration Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Pending users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- User Detail Modal -->
            <div id="userModal" class="modal" style="display: none;">
                <div class="modal-content large-modal">
                    <div class="modal-header">
                        <h3 id="modalTitle">User Details</h3>
                        <button class="btn-close" onclick="closeUserModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" id="userDetailContent">
                        <!-- User details will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Add/Edit User Modal -->
            <div id="userFormModal" class="modal" style="display: none;">
                <div class="modal-content medium-modal">
                    <div class="modal-header">
                        <h3 id="formModalTitle">Add New User</h3>
                        <button class="btn-close" onclick="closeFormModal()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="text-align: left;">
                        <form id="userForm">
                            <input type="hidden" id="editUserId">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="role">Role</label>
                                    <select id="formRole" name="role" required onchange="toggleFormFields()">
                                        <option value="student">Student</option>
                                        <option value="nurse">Nurse</option>
                                        <option value="admin">Administrator</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="firstName">First Name</label>
                                    <input type="text" id="formFirstName" name="firstName" required>
                                </div>
                                <div class="form-group">
                                    <label for="middleName">Middle Name</label>
                                    <input type="text" id="formMiddleName" name="middleName">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="lastName">Last Name</label>
                                    <input type="text" id="formLastName" name="lastName" required>
                                </div>
                                <div class="form-group">
                                    <label for="extensionName">Extension Name (e.g., Jr., III)</label>
                                    <input type="text" id="formExtensionName" name="extensionName">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="email">Email</label>
                                    <input type="email" id="formEmail" name="email" required>
                                </div>
                                <div class="form-group">
                                    <label for="contactNumber">Contact Number</label>
                                    <input type="text" id="formContactNumber" name="contactNumber">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="password">Password</label>
                                    <input type="password" id="formPassword" name="password" placeholder="Leave blank to keep current">
                                </div>
                                <div class="form-group">
                                    <label for="isEmailConfirmed">Status</label>
                                    <select id="formIsEmailConfirmed" name="isEmailConfirmed">
                                        <option value="1">Active (Confirmed)</option>
                                        <option value="0">Inactive (Pending)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="studentFields">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="idNumber">Student ID</label>
                                        <input type="text" id="formIdNumber" name="idNumber">
                                    </div>
                                    <div class="form-group">
                                        <label for="department">Department</label>
                                        <input type="text" id="formDepartment" name="department">
                                    </div>
                                </div>
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="schoolYear">School Year</label>
                                        <input type="text" id="formSchoolYear" name="schoolYear" placeholder="e.g., 2023-2024">
                                    </div>
                                    <div class="form-group">
                                        <label for="schoolLevel">School Level</label>
                                        <select id="formSchoolLevel" name="schoolLevel">
                                            <option value="">Select Level</option>
                                            <option value="1st Year">1st Year</option>
                                            <option value="2nd Year">2nd Year</option>
                                            <option value="3rd Year">3rd Year</option>
                                            <option value="4th Year">4th Year</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div id="nurseFields" style="display: none;">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="employeeId">Employee ID</label>
                                        <input type="text" id="formEmployeeId" name="employeeId">
                                    </div>
                                    <div class="form-group">
                                        <label for="specialization">Specialization</label>
                                        <input type="text" id="formSpecialization" name="specialization">
                                    </div>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="btn-primary">Save User</button>
                                <button type="button" class="btn-secondary" onclick="closeFormModal()">Cancel</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="js/common.js"></script>
    <script>
        // Global variables
        let currentPages = {
            students: 1,
            nurses: 1,
            admins: 1,
            pending: 1
        };

        // Global auth check
        (function() {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user'));
            
            if (!token || !user || user.role.toLowerCase() !== 'admin') {
                window.location.href = 'login.html';
            }
        })();

        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Tab functionality
        function showTab(element, tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.user-list');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Remove active class from tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (element) {
                element.classList.add('active');
            } else {
                // Fallback if element not provided
                const btn = document.querySelector(`.tab-btn[onclick*="'${tabName}'"]`);
                if (btn) btn.classList.add('active');
            }

            // Load data for the selected tab
            loadTabData(tabName);
        }

        // Load data for specific tabs
        function loadTabData(tabName) {
            const page = currentPages[tabName] || 1;
            switch(tabName) {
                case 'students':
                    loadStudents('', page);
                    break;
                case 'nurses':
                    loadNurses('', page);
                    break;
                case 'admins':
                    loadAdmins('', page);
                    break;
                case 'pending':
                    loadPendingUsers(page);
                    break;
            }
        }

        // Helper function for fetch with auth
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (token) {
                defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            }

            const combinedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            return fetch(url, combinedOptions);
        }

        // Load students data
        async function loadStudents(search = '', page = 1) {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'student',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users?${params}`);
                const result = await response.json();

                if (response.ok) {
                    displayStudents(result.users);
                    updatePagination(result.pagination, 'students');
                } else {
                    showError(result.message || 'Failed to load students');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading students</td></tr>';
                }
            } catch (error) {
                console.error('Error loading students:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading students</td></tr>';
            }
        }

        function displayStudents(students) {
            const tbody = document.querySelector('#studentsTable tbody');
            tbody.innerHTML = '';

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No students found</td></tr>';
                return;
            }

            students.forEach(student => {
                const fullName = `${student.first_name} ${student.middle_name || ''} ${student.last_name} ${student.extension_name || ''}`.trim();
                const statusBadge = student.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${student.role_specific_id || student.ctu_id || 'N/A'}</td>
                    <td>${student.email}</td>
                    <td>${student.department || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(student.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${student.id})">View</button>
                        <button class="btn-small" onclick="editUser(${student.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${student.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load nurses data
        async function loadNurses(search = '', page = 1) {
            const tbody = document.querySelector('#nursesTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'nurse',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users?${params}`);

                const result = await response.json();

                if (response.ok) {
                    displayNurses(result.users);
                    updatePagination(result.pagination, 'nurses');
                } else {
                    showError(result.message || 'Failed to load nurses');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading nurses</td></tr>';
                }
            } catch (error) {
                console.error('Error loading nurses:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading nurses</td></tr>';
            }
        }

        function displayNurses(nurses) {
            const tbody = document.querySelector('#nursesTable tbody');
            tbody.innerHTML = '';

            if (nurses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No nurses found</td></tr>';
                return;
            }

            nurses.forEach(nurse => {
                const fullName = `${nurse.first_name} ${nurse.middle_name || ''} ${nurse.last_name} ${nurse.extension_name || ''}`.trim();
                const statusBadge = nurse.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${nurse.role_specific_id || nurse.ctu_id || 'N/A'}</td>
                    <td>${nurse.email}</td>
                    <td>${nurse.specialization || 'N/A'}</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(nurse.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${nurse.id})">View</button>
                        <button class="btn-small" onclick="editUser(${nurse.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${nurse.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load admins data
        async function loadAdmins(search = '', page = 1) {
            const tbody = document.querySelector('#adminsTable tbody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Loading...</td></tr>';

            try {
                const params = new URLSearchParams({
                    role: 'admin',
                    page: page,
                    limit: 20
                });

                if (search) {
                    params.append('search', search);
                }

                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users?${params}`);

                const result = await response.json();

                if (response.ok) {
                    displayAdmins(result.users);
                    updatePagination(result.pagination, 'admins');
                } else {
                    showError(result.message || 'Failed to load admins');
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading admins</td></tr>';
                }
            } catch (error) {
                console.error('Error loading admins:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">Error loading admins</td></tr>';
            }
        }

        function displayAdmins(admins) {
            const tbody = document.querySelector('#adminsTable tbody');
            tbody.innerHTML = '';

            if (admins.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No admins found</td></tr>';
                return;
            }

            admins.forEach(admin => {
                const fullName = `${admin.first_name} ${admin.middle_name || ''} ${admin.last_name} ${admin.extension_name || ''}`.trim();
                const statusBadge = admin.is_email_confirmed ?
                    '<span class="status-badge active">Active</span>' :
                    '<span class="status-badge inactive">Inactive</span>';

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${admin.ctu_id || 'N/A'}</td>
                    <td>${admin.email}</td>
                    <td>Administrator</td>
                    <td>${statusBadge}</td>
                    <td>${new Date(admin.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small" onclick="viewUser(${admin.id})">View</button>
                        <button class="btn-small" onclick="editUser(${admin.id})">Edit</button>
                        <button class="btn-small btn-danger" onclick="deleteUser(${admin.id})">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Load pending users (users who haven't confirmed email)
        async function loadPendingUsers(page = 1) {
            const tbody = document.querySelector('#pendingTable tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading...</td></tr>';

            try {
                // For pending users, we might need a different endpoint or filter
                // For now, we'll load all users and filter client-side, or modify backend
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users?page=${page}&limit=50`);

                const result = await response.json();

                if (response.ok) {
                    // Filter users who haven't confirmed email
                    const pendingUsers = result.users.filter(user => !user.is_email_confirmed);
                    displayPendingUsers(pendingUsers);

                    // Update pending count
                    document.getElementById('pendingCount').textContent = pendingUsers.length;
                } else {
                    showError(result.message || 'Failed to load pending users');
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading pending users</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pending users:', error);
                showError('Network error. Please try again.');
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Error loading pending users</td></tr>';
            }
        }

        function displayPendingUsers(users) {
            const tbody = document.querySelector('#pendingTable tbody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pending users</td></tr>';
                return;
            }

            users.forEach(user => {
                const fullName = `${user.first_name} ${user.middle_name || ''} ${user.last_name} ${user.extension_name || ''}`.trim();
                const roleDisplay = user.role.charAt(0).toUpperCase() + user.role.slice(1);

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${fullName}</td>
                    <td>${user.email}</td>
                    <td>${roleDisplay}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn-small btn-success" onclick="approveUser(${user.id})">Approve</button>
                        <button class="btn-small btn-danger" onclick="rejectUser(${user.id})">Reject</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // User action functions
        async function viewUser(userId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users/${userId}`);

                const result = await response.json();

                if (response.ok) {
                    // Show user details in modal
                    displayUserDetails(result);
                    document.getElementById('userModal').style.display = 'flex';
                } else {
                    showError(result.message || 'Failed to load user details');
                }
            } catch (error) {
                console.error('Error viewing user:', error);
                showError('Network error. Please try again.');
            }
        }


        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User deleted successfully');
                    // Reload current tab data
                    const activeTab = document.querySelector('.tab-btn.active');
                    if (activeTab) {
                        // Extract tab name from onclick="showTab('students')"
                        const match = activeTab.getAttribute('onclick').match(/'(\w+)'/);
                        if (match) loadTabData(match[1]);
                    }
                    loadStatistics(); // Update stats
                } else {
                    showError(result.message || 'Failed to delete user');
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                showError('Network error. Please try again.');
            }
        }

        async function approveUser(userId) {
            if (!confirm('Approve this user registration?')) {
                return;
            }

            try {
                // Approve by setting is_email_confirmed to true
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users/${userId}`, {
                    method: 'PUT',
                    body: JSON.stringify({ isEmailConfirmed: true })
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess('User approved successfully');
                    loadPendingUsers(); // Reload pending users
                    loadStatistics(); // Update stats
                } else {
                    showError(result.message || 'Failed to approve user');
                }
            } catch (error) {
                console.error('Error approving user:', error);
                showError('Network error. Please try again.');
            }
        }

        async function rejectUser(userId) {
            if (!confirm('Reject this user registration? The user account will be deleted.')) {
                return;
            }

            // Reject by deleting the user
            await deleteUser(userId);
        }

        function displayUserDetails(user) {
            const fullName = `${user.first_name} ${user.middle_name || ''} ${user.last_name} ${user.extension_name || ''}`.trim();

            const detailsHtml = `
                <div class="user-details">
                    <div class="detail-row">
                        <strong>Name:</strong> ${fullName}
                    </div>
                    <div class="detail-row">
                        <strong>Email:</strong> ${user.email}
                    </div>
                    <div class="detail-row">
                        <strong>Role:</strong> ${user.role.charAt(0).toUpperCase() + user.role.slice(1)}
                    </div>
                    <div class="detail-row">
                        <strong>ID:</strong> ${user.ctu_id || 'N/A'}
                    </div>
                    <div class="detail-row">
                        <strong>Phone:</strong> ${user.contact_number || 'N/A'}
                    </div>
                    <div class="detail-row">
                        <strong>Email Confirmed:</strong> ${user.is_email_confirmed ? 'Yes' : 'No'}
                    </div>
                    <div class="detail-row">
                        <strong>Created:</strong> ${new Date(user.created_at).toLocaleDateString()}
                    </div>
                    ${user.role === 'student' ? `
                        <div class="detail-row">
                            <strong>School Year:</strong> ${user.school_year || 'N/A'}
                        </div>
                        <div class="detail-row">
                            <strong>School Level:</strong> ${user.school_level || 'N/A'}
                        </div>
                        <div class="detail-row">
                            <strong>Department:</strong> ${user.department || 'N/A'}
                        </div>
                    ` : ''}
                    ${user.role === 'nurse' ? `
                        <div class="detail-row">
                            <strong>License Number:</strong> ${user.role_specific_id || 'N/A'}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('userDetailContent').innerHTML = detailsHtml;
        }

        function showAddUserModal() {
            document.getElementById('formModalTitle').textContent = 'Add New User';
            document.getElementById('editUserId').value = '';
            document.getElementById('userForm').reset();
            document.getElementById('formIsEmailConfirmed').value = "1"; // Default to active for manual creation
            document.getElementById('formPassword').required = true;
            toggleFormFields();
            document.getElementById('userFormModal').style.display = 'flex';
        }

        function closeFormModal() {
            document.getElementById('userFormModal').style.display = 'none';
        }

        function showBulkImportModal() {
            alert('Bulk import functionality: Please select a CSV file with columns: firstName, lastName, email, role, idNumber/employeeId.');
        }

        function showPasswordResetModal() {
            const email = prompt('Enter the email address of the user to reset password:');
            if (email) {
                alert(`Password reset link has been sent to ${email}`);
            }
        }

        function exportUsers() {
            const format = prompt('Enter export format (csv, excel, pdf):', 'csv');
            if (format) {
                alert(`User data export initiated in ${format.toUpperCase()} format.`);
            }
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        function toggleFormFields() {
            const role = document.getElementById('formRole').value;
            const studentFields = document.getElementById('studentFields');
            const nurseFields = document.getElementById('nurseFields');

            if (role === 'student') {
                studentFields.style.display = 'block';
                nurseFields.style.display = 'none';
            } else if (role === 'nurse') {
                studentFields.style.display = 'none';
                nurseFields.style.display = 'block';
            } else {
                studentFields.style.display = 'none';
                nurseFields.style.display = 'none';
            }
        }

        async function editUser(userId) {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/users/${userId}`);

                const user = await response.json();

                if (response.ok) {
                    document.getElementById('formModalTitle').textContent = 'Edit User';
                    document.getElementById('editUserId').value = user.id;
                    document.getElementById('formRole').value = user.role;
                    document.getElementById('formFirstName').value = user.first_name || '';
                    document.getElementById('formMiddleName').value = user.middle_name || '';
                    document.getElementById('formLastName').value = user.last_name || '';
                    document.getElementById('formExtensionName').value = user.extension_name || '';
                    document.getElementById('formEmail').value = user.email || '';
                    document.getElementById('formContactNumber').value = user.contact_number || '';
                    document.getElementById('formIsEmailConfirmed').value = user.is_email_confirmed ? "1" : "0";
                    document.getElementById('formPassword').required = false;
                    document.getElementById('formPassword').value = '';

                    if (user.role === 'student') {
                        document.getElementById('formIdNumber').value = user.ctu_id || '';
                        document.getElementById('formDepartment').value = user.department || '';
                        document.getElementById('formSchoolYear').value = user.school_year || '';
                        document.getElementById('formSchoolLevel').value = user.school_level || '';
                    } else if (user.role === 'nurse') {
                        document.getElementById('formEmployeeId').value = user.ctu_id || '';
                        document.getElementById('formSpecialization').value = user.specialization || '';
                    }

                    toggleFormFields();
                    document.getElementById('userFormModal').style.display = 'flex';
                } else {
                    showError(user.message || 'Failed to load user data');
                }
            } catch (error) {
                console.error('Error loading user for edit:', error);
                showError('Network error. Please try again.');
            }
        }

        document.getElementById('userForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('editUserId').value;
            const isEdit = userId !== '';
            const formData = new FormData(this);
            const userData = Object.fromEntries(formData.entries());

            // Remove password if empty on edit
            if (isEdit && !userData.password) {
                delete userData.password;
            }

            const method = isEdit ? 'PUT' : 'POST';
            const url = isEdit ? `${API_BASE_URL}/admin/users/${userId}` : `${API_BASE_URL}/admin/users`;

            try {
                const response = await fetchWithAuth(url, {
                    method: method,
                    body: JSON.stringify(userData)
                });

                const result = await response.json();

                if (response.ok) {
                    showSuccess(isEdit ? 'User updated successfully' : 'User created successfully');
                    closeFormModal();
                    loadStatistics();
                    loadTabData('students'); // Or current active tab
                } else {
                    showError(result.message || 'Action failed');
                }
            } catch (error) {
                console.error('Error saving user:', error);
                showError('Network error. Please try again.');
            }
        });

        // Load statistics
        async function loadStatistics() {
            try {
                const response = await fetchWithAuth(`${API_BASE_URL}/admin/statistics`);

                const result = await response.json();

                if (response.ok) {
                    // Update statistics cards
                    const userStats = result.userStats || [];
                    const studentStat = userStats.find(stat => stat.role === 'student') || { count: 0 };
                    const nurseStat = userStats.find(stat => stat.role === 'nurse') || { count: 0 };
                    const adminStat = userStats.find(stat => stat.role === 'admin') || { count: 0 };

                    document.getElementById('totalStudents').textContent = studentStat.count;
                    document.getElementById('activeNurses').textContent = nurseStat.count;
                    document.getElementById('totalAdmins').textContent = adminStat.count;

                    // Update pending users count from the API
                    document.getElementById('pendingUsers').textContent = result.pendingUsers || 0;
                } else {
                    console.error('Failed to load statistics:', result.message);
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
            }
        }

        // Search and filter functionality
        function initializeSearchAndFilters() {
            // Student search
            const studentSearch = document.getElementById('studentSearch');
            if (studentSearch) {
                let studentSearchTimeout;
                studentSearch.addEventListener('input', function() {
                    clearTimeout(studentSearchTimeout);
                    studentSearchTimeout = setTimeout(() => {
                        currentPages.students = 1; // Reset to page 1 on search
                        loadStudents(this.value, 1);
                    }, 500);
                });
            }

            // Nurse search
            const nurseSearch = document.getElementById('nurseSearch');
            if (nurseSearch) {
                let nurseSearchTimeout;
                nurseSearch.addEventListener('input', function() {
                    clearTimeout(nurseSearchTimeout);
                    nurseSearchTimeout = setTimeout(() => {
                        currentPages.nurses = 1; // Reset to page 1 on search
                        loadNurses(this.value, 1);
                    }, 500);
                });
            }

            // Admin search
            const adminSearch = document.getElementById('adminSearch');
            if (adminSearch) {
                let adminSearchTimeout;
                adminSearch.addEventListener('input', function() {
                    clearTimeout(adminSearchTimeout);
                    adminSearchTimeout = setTimeout(() => {
                        currentPages.admins = 1; // Reset to page 1 on search
                        loadAdmins(this.value, 1);
                    }, 500);
                });
            }
        }

        // Pagination function
        function updatePagination(pagination, type) {
            const paginationContainer = document.getElementById(`${type}Pagination`);
            const pageInfo = document.getElementById(`${type}PageInfo`);
            
            if (!paginationContainer || !pageInfo) return;

            if (pagination.pages > 1) {
                paginationContainer.style.display = 'flex';
                pageInfo.textContent = `Page ${pagination.page} of ${pagination.pages}`;

                const prevBtn = document.getElementById(`${type}PrevPage`);
                const nextBtn = document.getElementById(`${type}NextPage`);

                // Create new buttons to clear old event listeners
                const newPrevBtn = prevBtn.cloneNode(true);
                const newNextBtn = nextBtn.cloneNode(true);
                
                prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
                nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

                newPrevBtn.disabled = pagination.page <= 1;
                newNextBtn.disabled = pagination.page >= pagination.pages;

                newPrevBtn.addEventListener('click', () => changePage(type, pagination.page - 1));
                newNextBtn.addEventListener('click', () => changePage(type, pagination.page + 1));
            } else {
                paginationContainer.style.display = 'none';
            }
        }

        function changePage(type, page) {
            currentPages[type] = page;
            const searchInput = document.getElementById(`${type.slice(0, -1)}Search`); // Remove 's' from end
            const searchValue = searchInput ? searchInput.value : '';

            switch(type) {
                case 'students':
                    loadStudents(searchValue, page);
                    break;
                case 'nurses':
                    loadNurses(searchValue, page);
                    break;
                case 'admins':
                    loadAdmins(searchValue, page);
                    break;
                case 'pending':
                    loadPendingUsers(page);
                    break;
            }
        }

        // Load initial data
        loadStatistics();
        initializeSearchAndFilters();
        loadStudents();
    </script>
</body>
</html>