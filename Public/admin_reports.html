<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Reports - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="admin_settings.html" class="dropdown-item">
                    <i class="fas fa-cog"></i> Settings
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="admin_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="admin_users.html"><span class="nav-icon"><i class="fas fa-users-cog"></i></span><span class="nav-text">User Management</span></a></li>
                <li><a href="admin_reports.html" class="active"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="admin_settings.html"><span class="nav-icon"><i class="fas fa-cogs"></i></span><span class="nav-text">Settings</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>System Reports & Analytics</h2>
                <p class="dashboard-subtitle">Generate comprehensive reports and analyze system performance metrics</p>
            </div>

            <!-- Report Categories -->
            <div class="reports-grid">
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-users"></i></div>
                    <h3>User Statistics</h3>
                    <p>Detailed breakdown of user registrations, activity levels, and demographic data</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateUserStats()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewUserStats()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-calendar-alt"></i></div>
                    <h3>Appointment Analytics</h3>
                    <p>Comprehensive appointment trends, utilization rates, and scheduling patterns</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateAppointmentAnalytics()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewAppointmentAnalytics()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>System Usage</h3>
                    <p>Platform usage statistics, feature adoption, and user engagement metrics</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateUsageReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewUsageReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-file-medical"></i></div>
                    <h3>Health Records Summary</h3>
                    <p>Medical records overview, treatment patterns, and health service utilization</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateHealthSummary()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewHealthSummary()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-clock"></i></div>
                    <h3>Performance Metrics</h3>
                    <p>System performance indicators, response times, and operational efficiency</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generatePerformanceReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewPerformanceReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-shield-alt"></i></div>
                    <h3>Security Audit</h3>
                    <p>Security events, access logs, and compliance monitoring reports</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateSecurityReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewSecurityReport()">Preview</button>
                    </div>
                </div>
            </div>

            <!-- Advanced Report Builder -->
            <div class="form-card">
                <div class="form-header">
                    <h3>Advanced Report Builder</h3>
                    <p>Create custom reports with specific parameters and date ranges</p>
                </div>
                <form id="advancedReportForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportType">Report Type</label>
                            <select id="reportType" name="reportType" required>
                                <option value="">Select Report Type</option>
                                <option value="user-activity">User Activity</option>
                                <option value="appointment-trends">Appointment Trends</option>
                                <option value="system-performance">System Performance</option>
                                <option value="financial-summary">Financial Summary</option>
                                <option value="compliance-audit">Compliance Audit</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateRange">Time Period</label>
                            <select id="dateRange" name="dateRange" required>
                                <option value="">Select Period</option>
                                <option value="last-7-days">Last 7 Days</option>
                                <option value="last-30-days">Last 30 Days</option>
                                <option value="last-3-months">Last 3 Months</option>
                                <option value="last-6-months">Last 6 Months</option>
                                <option value="last-year">Last Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="customDateRange" style="display: none;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="includeCharts">Include Charts</label>
                            <input type="checkbox" id="includeCharts" name="includeCharts" checked>
                        </div>
                        <div class="form-group">
                            <label for="exportFormat">Export Format</label>
                            <select id="exportFormat" name="exportFormat">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Generate Advanced Report</button>
                        <button type="button" class="btn-secondary" onclick="saveReportTemplate()">Save Template</button>
                        <button type="button" class="btn-secondary" onclick="resetAdvancedForm()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Scheduled Reports -->
            <div class="form-card">
                <div class="form-header">
                    <h3>Scheduled Reports</h3>
                    <p>Automate report generation and delivery</p>
                </div>
                <div class="scheduled-reports">
                    <div class="scheduled-report-item">
                        <div class="report-info">
                            <h4>Weekly User Activity Report</h4>
                            <p>Generated every Monday at 9:00 AM</p>
                            <span class="schedule-status active">Active</span>
                        </div>
                        <div class="report-actions">
                            <button class="btn-small" onclick="editSchedule(1)">Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteSchedule(1)">Delete</button>
                        </div>
                    </div>
                    <div class="scheduled-report-item">
                        <div class="report-info">
                            <h4>Monthly Performance Summary</h4>
                            <p>Generated on the 1st of each month at 8:00 AM</p>
                            <span class="schedule-status active">Active</span>
                        </div>
                        <div class="report-actions">
                            <button class="btn-small" onclick="editSchedule(2)">Edit</button>
                            <button class="btn-small btn-danger" onclick="deleteSchedule(2)">Delete</button>
                        </div>
                    </div>
                    <button class="btn-primary" onclick="createNewSchedule()">Create New Schedule</button>
                </div>
            </div>

            <!-- Report Output -->
            <div class="report-output" id="reportOutput" style="display: none;">
                <div class="report-header">
                    <h3 id="reportTitle">Report Results</h3>
                    <div class="report-meta">
                        <span id="reportDate">Generated on: --</span>
                        <span id="reportPeriod">Period: --</span>
                    </div>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="printReport()"><i class="fas fa-print"></i> Print</button>
                        <button class="btn-primary" onclick="exportReport()"><i class="fas fa-download"></i> Export</button>
                        <button class="btn-primary" onclick="emailReport()"><i class="fas fa-envelope"></i> Email</button>
                        <button class="btn-secondary" onclick="scheduleReport()"><i class="fas fa-clock"></i> Schedule</button>
                        <button class="btn-secondary" onclick="closeReport()"><i class="fas fa-times"></i> Close</button>
                    </div>
                </div>
                <div id="reportContent">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Date range toggle
        document.getElementById('dateRange').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }
        });

        // Helper function for fetch with auth
        async function fetchWithAuth(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (token) {
                defaultOptions.headers['Authorization'] = `Bearer ${token}`;
            }

            const combinedOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...(options.headers || {})
                }
            };

            return fetch(url, combinedOptions);
        }

        // Report generation functions
        async function generateUserStats() {
            try {
                const response = await fetchWithAuth('/api/admin/statistics');
                const stats = await response.json();
                
                if (response.ok) {
                    let content = '<h4>User Breakdown</h4><ul>';
                    stats.userStats.forEach(s => {
                        content += `<li>${s.role.charAt(0).toUpperCase() + s.role.slice(1)}: ${s.count}</li>`;
                    });
                    content += '</ul>';
                    
                    content += '<h4>Growth (Last 30 Days)</h4><ul>';
                    content += `<li>New Students: ${stats.recentActivity.new_students}</li>`;
                    content += `<li>New Nurses: ${stats.recentActivity.new_nurses}</li>`;
                    content += '</ul>';
                    
                    showReport('User Statistics Report', content);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate report');
            }
        }

        async function generateAppointmentAnalytics() {
            try {
                const response = await fetchWithAuth('/api/reports/appointments');
                const report = await response.json();
                
                if (response.ok) {
                    let table = '<table class="report-table"><thead><tr><th>Date</th><th>Student</th><th>Nurse</th><th>Reason</th><th>Status</th></tr></thead><tbody>';
                    report.data.forEach(row => {
                        table += `<tr><td>${new Date(row.appointment_date).toLocaleDateString()}</td><td>${row.student_name}</td><td>${row.nurse_name}</td><td>${row.reason}</td><td>${row.status}</td></tr>`;
                    });
                    table += '</tbody></table>';
                    showReport('Appointment Analytics Report', table);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate report');
            }
        }

        async function generateHealthSummary() {
            try {
                const response = await fetchWithAuth('/api/reports/medical-records');
                const report = await response.json();
                
                if (response.ok) {
                    let table = '<table class="report-table"><thead><tr><th>Date</th><th>Student</th><th>Record Type</th><th>Diagnosis</th></tr></thead><tbody>';
                    report.data.forEach(row => {
                        table += `<tr><td>${new Date(row.visit_date).toLocaleDateString()}</td><td>${row.student_name}</td><td>${row.record_type}</td><td>${row.diagnosis}</td></tr>`;
                    });
                    table += '</tbody></table>';
                    showReport('Health Records Summary Report', table);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate report');
            }
        }

        async function generateSecurityReport() {
            try {
                const response = await fetchWithAuth('/api/admin/audit-log?limit=100');
                const report = await response.json();
                
                if (response.ok) {
                    let table = '<table class="report-table"><thead><tr><th>Time</th><th>User</th><th>Action</th><th>Table</th></tr></thead><tbody>';
                    report.logs.forEach(row => {
                        table += `<tr><td>${new Date(row.created_at).toLocaleString()}</td><td>${row.email || 'System'}</td><td>${row.action}</td><td>${row.table_name || 'N/A'}</td></tr>`;
                    });
                    table += '</tbody></table>';
                    showReport('Security Audit Report', table);
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to generate report');
            }
        }

        // Preview functions
        function previewUserStats() {
            showReport('User Statistics Preview', 'Preview of user statistics data...');
        }

        function previewAppointmentAnalytics() {
            showReport('Appointment Analytics Preview', 'Preview of appointment analytics...');
        }

        function previewUsageReport() {
            showReport('System Usage Preview', 'Preview of system usage statistics...');
        }

        function previewHealthSummary() {
            showReport('Health Records Preview', 'Preview of health records summary...');
        }

        function previewPerformanceReport() {
            showReport('Performance Preview', 'Preview of performance metrics...');
        }

        function previewSecurityReport() {
            showReport('Security Preview', 'Preview of security audit data...');
        }

        // Utility functions
        function showReport(title, content) {
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportDate').textContent = 'Generated on: ' + new Date().toLocaleDateString();
            document.getElementById('reportPeriod').textContent = 'Period: Last 30 days';
            document.getElementById('reportContent').innerHTML = `<p>${content}</p>`;
            document.getElementById('reportOutput').style.display = 'block';
            document.getElementById('reportOutput').scrollIntoView({ behavior: 'smooth' });
        }

        function closeReport() {
            document.getElementById('reportOutput').style.display = 'none';
        }

        function printReport() {
            window.print();
        }

        function exportReport() {
            alert('Export functionality coming soon!');
        }

        function emailReport() {
            alert('Email functionality coming soon!');
        }

        function scheduleReport() {
            alert('Schedule functionality coming soon!');
        }

        function saveReportTemplate() {
            alert('Template saved successfully!');
        }

        function resetAdvancedForm() {
            document.getElementById('advancedReportForm').reset();
            document.getElementById('customDateRange').style.display = 'none';
        }

        function editSchedule(id) {
            alert(`Editing schedule ${id}`);
        }

        function deleteSchedule(id) {
            if (confirm('Delete this scheduled report?')) {
                alert(`Schedule ${id} deleted`);
            }
        }

        function createNewSchedule() {
            alert('Create new schedule functionality coming soon!');
        }
    </script>
</body>
</html>