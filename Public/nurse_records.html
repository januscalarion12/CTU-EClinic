<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Records - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .table-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
            margin-top: 20px;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }
        .data-table th, .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        .data-table tr:hover {
            background-color: #f1f4f8;
        }
        .record-type-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.85em;
            text-transform: capitalize;
        }
        .type-consultation { background: #e3f2fd; color: #1976d2; }
        .type-checkup { background: #e8f5e9; color: #2e7d32; }
        .type-emergency { background: #ffebee; color: #c62828; }
        .type-vaccination { background: #f3e5f5; color: #7b1fa2; }
        .type-follow_up { background: #fff3e0; color: #ef6c00; }
        
        .truncate-cell {
            max-width: 200px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .actions-cell {
            white-space: nowrap;
        }
        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            margin: 0 4px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .btn-view { color: #2196f3; }
        .btn-edit { color: #ff9800; }
        .btn-delete { color: #f44336; }
        .btn-icon:hover { background-color: rgba(0,0,0,0.05); }
        .text-center { text-align: center; }
    </style>
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>CTU Bantayan E-Clinic</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html" class="active"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="nurse_scan.html"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="archive.html"><span class="nav-icon"><i class="fas fa-archive"></i></span><span class="nav-text">Archive</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Medical Records Management</h2>
                <p class="dashboard-subtitle">Access and manage student medical records and health information</p>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
                    <h3>Add New Record</h3>
                    <p>Create a new medical record for a student</p>
                    <button class="btn-primary" onclick="showAddRecordForm()">Add Record</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-search"></i></div>
                    <h3>Search Records</h3>
                    <p>Find patient records by name or ID</p>
                    <button class="btn-primary" onclick="focusSearch()">Search</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file-export"></i></div>
                    <h3>Export Records</h3>
                    <p>Export medical records for reporting</p>
                    <button class="btn-primary" onclick="exportRecords()">Export</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-history"></i></div>
                    <h3>Recent Activity</h3>
                    <p>View recently accessed records</p>
                    <button class="btn-primary" onclick="showRecentActivity()">View Activity</button>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="search-form">
                <div class="search-row">
                    <div class="search-input-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchStudent" class="search-input" placeholder="Search by student name, ID, or condition...">
                    </div>
                    <div class="filter-group">
                        <select id="recordTypeFilter" class="filter-select">
                            <option value="">All Record Types</option>
                            <option value="consultation">Consultation</option>
                            <option value="checkup">Checkup</option>
                            <option value="vaccination">Vaccination</option>
                            <option value="emergency">Emergency</option>
                            <option value="follow_up">Follow-up</option>
                        </select>
                        <select id="dateFilter" class="filter-select">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                        <button id="searchBtn" class="btn-primary">Search</button>
                        <button id="clearBtn" class="btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Records List -->
            <div class="records-list">
                <div class="list-header">
                    <h3>Student Records</h3>
                    <div class="list-stats">
                        <span id="totalRecords">0</span> records found
                    </div>
                </div>
                <div class="table-container">
                    <table id="recordsTable" class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Student</th>
                                <th>Type</th>
                                <th>Diagnosis</th>
                                <th>Treatment</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recordsContainer">
                            <!-- Records will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Add/Edit Record Form -->
            <div class="record-form" id="recordForm" style="display: none;">
                <div class="form-card">
                    <div class="form-header">
                        <h3 id="formTitle">Add New Medical Record</h3>
                        <p>Enter student information and medical details</p>
                    </div>
                    <form id="addRecordForm">
                        <input type="hidden" id="recordId" name="recordId">
                        <input type="hidden" id="internalStudentId" name="internalStudentId">
                        <input type="hidden" id="appointmentId" name="appointmentId">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentId">Student ID/Number</label>
                                <input type="text" id="studentId" name="studentId" required placeholder="Enter Student Number">
                            </div>
                            <div class="form-group">
                                <label for="studentName">Student Name</label>
                                <input type="text" id="studentName" name="studentName" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recordType">Record Type</label>
                                <select id="recordType" name="recordType" required>
                                    <option value="">Select Type</option>
                                    <option value="consultation">Consultation</option>
                                    <option value="checkup">Checkup</option>
                                    <option value="vaccination">Vaccination</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="follow_up">Follow-up</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="visitDate">Visit Date</label>
                                <input type="date" id="visitDate" name="visitDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="symptoms">Symptoms</label>
                            <textarea id="symptoms" name="symptoms" rows="2" required placeholder="Enter student's symptoms"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="diagnosis">Diagnosis/Condition</label>
                            <textarea id="diagnosis" name="diagnosis" rows="3" required placeholder="Describe the medical condition or diagnosis"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="treatment">Treatment Provided</label>
                            <textarea id="treatment" name="treatment" rows="3" required placeholder="Describe the treatment administered"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="medication">Medication Prescribed</label>
                                <textarea id="medication" name="medication" rows="2" placeholder="List any medications prescribed"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="followUp">Follow-up Required</label>
                                <select id="followUp" name="followUp">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">Additional Notes</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Any additional observations or notes"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save Record</button>
                            <button type="button" id="cancelBtn" class="btn-secondary" onclick="hideRecordForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <!-- Recent Activity Modal -->
    <div id="activityModal" class="modal" style="display: none;">
        <div class="modal-content large-modal">
            <div class="modal-header">
                <h3>Recent Medical Record Activity</h3>
                <button class="btn-close" onclick="document.getElementById('activityModal').style.display='none'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date/Time</th>
                                <th>Student</th>
                                <th>Type</th>
                                <th>Diagnosis</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="activityContainer">
                            <!-- Recent activity will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        document.getElementById('studentId').addEventListener('input', function() {
            const studentId = this.value;
            if (studentId) {
                // Clear current info while fetching
                document.getElementById('internalStudentId').value = '';
                document.getElementById('studentName').value = 'Looking up...';
                
                // Debounce lookup
                clearTimeout(this.lookupTimeout);
                this.lookupTimeout = setTimeout(() => {
                    fetchStudentInfo(studentId);
                }, 500);
            } else {
                document.getElementById('internalStudentId').value = '';
                document.getElementById('studentName').value = '';
            }
        });

        // Form functions
        function showAddRecordForm() {
            document.getElementById('formTitle').textContent = 'Add New Medical Record';
            document.getElementById('recordForm').style.display = 'block';
            document.getElementById('studentId').readOnly = false;
            
            // Don't reset if we have a studentId in URL
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdFromUrl = urlParams.get('studentId');
            
            if (!studentIdFromUrl) {
                document.getElementById('addRecordForm').reset();
                document.getElementById('internalStudentId').value = '';
                document.getElementById('studentId').focus();
            } else {
                // If studentId from URL, just clear the other fields but keep the student info
                document.getElementById('recordId').value = '';
                document.getElementById('recordType').value = '';
                document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
                document.getElementById('symptoms').value = '';
                document.getElementById('diagnosis').value = '';
                document.getElementById('treatment').value = '';
                document.getElementById('medication').value = '';
                document.getElementById('notes').value = '';
                
                // Trigger student info fetch if not already populated
                if (!document.getElementById('internalStudentId').value) {
                    const appointmentIdFromUrl = urlParams.get('appointmentId');
                    if (appointmentIdFromUrl) {
                        fetchAppointmentInfo(appointmentIdFromUrl);
                    } else {
                        fetchStudentInfo(studentIdFromUrl);
                    }
                }
            }
        }

        function hideRecordForm() {
            document.getElementById('recordForm').style.display = 'none';
            document.getElementById('addRecordForm').reset();
            document.getElementById('internalStudentId').value = '';
            document.getElementById('appointmentId').value = '';
            document.getElementById('studentId').readOnly = false;
        }

        function focusSearch() {
            document.getElementById('searchStudent').focus();
        }

        function clearFilters() {
            const searchInput = document.getElementById('searchStudent');
            searchInput.value = '';
            searchInput.style.paddingLeft = '40px';
            document.querySelector('.search-icon').style.display = 'block';
            document.getElementById('recordTypeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            loadRecords();
        }

        async function exportRecords() {
            try {
                const search = document.getElementById('searchStudent').value;
                const recordType = document.getElementById('recordTypeFilter').value;
                const dateRange = document.getElementById('dateFilter').value;

                let url = '/api/reports/medical-records?';
                const params = new URLSearchParams();
                if (recordType) params.append('recordType', recordType);
                if (dateRange) {
                    const today = new Date();
                    let startDate = new Date();
                    if (dateRange === 'today') startDate = today;
                    else if (dateRange === 'week') startDate.setDate(today.getDate() - 7);
                    else if (dateRange === 'month') startDate.setMonth(today.getMonth() - 1);
                    else if (dateRange === 'year') startDate.setFullYear(today.getFullYear() - 1);
                    
                    params.append('startDate', startDate.toISOString().split('T')[0]);
                    params.append('endDate', today.toISOString().split('T')[0]);
                }

                const response = await fetch(url + params.toString(), {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const result = await response.json();
                    const records = result.data;

                    if (records.length === 0) {
                        alert('No records found to export with current filters.');
                        return;
                    }

                    // Convert to CSV
                    const headers = ['Date', 'Student Name', 'Student ID', 'Type', 'Symptoms', 'Diagnosis', 'Treatment', 'Medications', 'Notes'];
                    const csvContent = [
                        headers.join(','),
                        ...records.map(r => [
                            new Date(r.visit_date).toLocaleDateString(),
                            `"${r.student_name || ''}"`,
                            `"${r.student_id || ''}"`,
                            r.record_type,
                            `"${(r.symptoms || '').replace(/"/g, '""')}"`,
                            `"${(r.diagnosis || '').replace(/"/g, '""')}"`,
                            `"${(r.treatment || '').replace(/"/g, '""')}"`,
                            `"${(r.medications || '').replace(/"/g, '""')}"`,
                            `"${(r.notes || '').replace(/"/g, '""')}"`
                        ].join(','))
                    ].join('\n');

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `medical_records_export_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    alert('Error generating export data');
                }
            } catch (error) {
                console.error('Export error:', error);
                alert('Error during export');
            }
        }

        async function showRecentActivity() {
            const container = document.getElementById('activityContainer');
            const modal = document.getElementById('activityModal');
            
            container.innerHTML = '<tr><td colspan="5" class="text-center">Loading activity...</td></tr>';
            modal.style.display = 'block';

            try {
                const response = await fetch('/api/medical-records/recent', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (response.ok) {
                    const activity = await response.json();
                    if (activity.length === 0) {
                        container.innerHTML = '<tr><td colspan="5" class="text-center">No recent activity found.</td></tr>';
                        return;
                    }

                    container.innerHTML = activity.map(act => `
                        <tr>
                            <td>${new Date(act.created_at).toLocaleString()}</td>
                            <td>${act.student_name || 'Unknown Student'} (${act.student_id_number || 'N/A'})</td>
                            <td><span class="record-type-badge type-${act.record_type}">${act.record_type}</span></td>
                            <td class="truncate-cell">${act.diagnosis || 'N/A'}</td>
                            <td>
                                <button class="btn-small btn-primary" onclick="viewRecordDetails(${act.id})">View</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    container.innerHTML = '<tr><td colspan="5" class="text-center">Error loading activity.</td></tr>';
                }
            } catch (error) {
                console.error('Activity error:', error);
                container.innerHTML = '<tr><td colspan="5" class="text-center">Error loading activity.</td></tr>';
            }
        }

        // Load records
        async function loadRecords() {
            const container = document.getElementById('recordsContainer');
            const search = document.getElementById('searchStudent').value;
            const recordType = document.getElementById('recordTypeFilter').value;
            const dateRange = document.getElementById('dateFilter').value;

            // Get studentId from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdFromUrl = urlParams.get('studentId');

            try {
                if (studentIdFromUrl) {
                    const response = await fetch(`/api/medical-records/student/${studentIdFromUrl}`);
                    if (response.ok) {
                        const records = await response.json();
                        displayRecords(records);
                        fetchStudentInfo(studentIdFromUrl);
                    }
                } else if (search) {
                    // Search students first to get ID
                    const response = await fetch(`/api/nurse/students?search=${search}`);
                    if (response.ok) {
                        const students = await response.json();
                        if (students.length > 0) {
                            // Fetch records for the first matching student as an example
                            const studentId = students[0].id;
                            const recResponse = await fetch(`/api/medical-records/student/${studentId}`);
                            if (recResponse.ok) {
                                const records = await recResponse.json();
                                displayRecords(records);
                            }
                        } else {
                            container.innerHTML = '<p>No students found matching your search.</p>';
                        }
                    }
                } else {
                    // Load all students the nurse has access to
                    const response = await fetch('/api/nurse/students');
                    if (response.ok) {
                        const students = await response.json();
                        // Maybe we should list students first? 
                        // The current UI expects records. Let's fetch records for all these students.
                        container.innerHTML = '<p>Please search for a student to view their records.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading records:', error);
                container.innerHTML = '<p>Error loading records</p>';
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            if (records.length === 0) {
                container.innerHTML = '<tr><td colspan="6" class="text-center">No records found for this student.</td></tr>';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }

            container.innerHTML = records.map(record => `
                <tr>
                    <td>${new Date(record.visit_date).toLocaleDateString()}</td>
                    <td>${record.student_name || 'Unknown Student'} (${record.student_id_number || 'N/A'})</td>
                    <td><span class="record-type-badge type-${record.record_type}">${record.record_type}</span></td>
                    <td class="truncate-cell" title="${record.diagnosis || 'N/A'}">${record.diagnosis || 'N/A'}</td>
                    <td class="truncate-cell" title="${record.treatment || 'N/A'}">${record.treatment || 'N/A'}</td>
                    <td class="actions-cell">
                        <button class="btn-icon btn-view" onclick="viewRecordDetails(${record.id})" title="View Details"><i class="fas fa-eye"></i></button>
                        <button class="btn-icon btn-edit" onclick="editRecord(${record.id})" title="Edit Record"><i class="fas fa-edit"></i></button>
                        <button class="btn-icon btn-delete" onclick="deleteRecord(${record.id})" title="Delete Record"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('');
            document.getElementById('totalRecords').textContent = records.length;
        }

        async function editRecord(recordId) {
            try {
                const response = await fetch(`/api/medical-records/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    
                    // Populate form
                    document.getElementById('recordId').value = record.id;
                    document.getElementById('internalStudentId').value = record.student_id;
                    document.getElementById('studentId').value = record.student_id_number || record.ctu_id || record.student_id;
                    document.getElementById('studentName').value = record.student_name;
                    document.getElementById('recordType').value = record.record_type;
                    document.getElementById('visitDate').value = new Date(record.visit_date).toISOString().split('T')[0];
                    document.getElementById('symptoms').value = record.symptoms || '';
                    document.getElementById('diagnosis').value = record.diagnosis || '';
                    document.getElementById('treatment').value = record.treatment || '';
                    document.getElementById('medication').value = record.medications || '';
                    document.getElementById('followUp').value = record.follow_up_required ? 'yes' : 'no';
                    document.getElementById('notes').value = record.notes || '';
                    
                    document.getElementById('formTitle').textContent = 'Edit Medical Record';
                    document.getElementById('recordForm').style.display = 'block';
                    document.getElementById('recordForm').scrollIntoView({ behavior: 'smooth' });
                    
                    // Make student ID readonly during edit
                    document.getElementById('studentId').readOnly = true;
                } else {
                    const error = await response.json();
                    alert('Error fetching record: ' + error.message);
                }
            } catch (error) {
                console.error('Error editing record:', error);
                alert('Error fetching record details');
            }
        }

        async function deleteRecord(recordId) {
            if (confirm('Are you sure you want to archive this medical record? You can restore it from the Archive page later.')) {
                try {
                    const response = await fetch(`/api/medical-records/${recordId}`, {
                        method: 'DELETE',
                        credentials: 'include'
                    });

                    if (response.ok) {
                        alert('Record archived successfully!');
                        window.location.href = 'archive.html';
                    } else {
                        const error = await response.json();
                        alert('Error archiving record: ' + error.message);
                    }
                } catch (error) {
                    console.error('Error archiving record:', error);
                    alert('Error archiving record');
                }
            }
        }

        async function viewRecordDetails(recordId) {
            try {
                const response = await fetch(`/api/medical-records/${recordId}`);
                if (response.ok) {
                    const record = await response.json();
                    alert(`Record Details:\nStudent: ${record.student_name}\nType: ${record.record_type}\nDiagnosis: ${record.diagnosis}\nTreatment: ${record.treatment}`);
                }
            } catch (error) {
                console.error('Error viewing record details:', error);
            }
        }

        async function fetchStudentInfo(studentId) {
            if (!studentId) {
                document.getElementById('internalStudentId').value = '';
                document.getElementById('studentName').value = '';
                return;
            }

            try {
                const response = await fetch(`/api/nurse/students/${studentId}`);
                if (response.ok) {
                    const student = await response.json();
                    document.getElementById('internalStudentId').value = student.id;
                    document.getElementById('studentName').value = student.name;
                    document.getElementById('studentName').style.color = 'inherit';
                } else {
                    document.getElementById('internalStudentId').value = '';
                    document.getElementById('studentName').value = 'Student not found';
                    document.getElementById('studentName').style.color = 'red';
                }
            } catch (error) {
                console.error('Error fetching student info:', error);
                document.getElementById('internalStudentId').value = '';
                document.getElementById('studentName').value = 'Error looking up student';
            }
        }

        async function fetchAppointmentInfo(appointmentId) {
            if (!appointmentId) return;
            
            try {
                const response = await fetch(`/api/nurse/appointments/${appointmentId}`);
                if (response.ok) {
                    const appointment = await response.json();
                    document.getElementById('appointmentId').value = appointment.id;
                    document.getElementById('internalStudentId').value = appointment.student_id;
                    document.getElementById('studentId').value = appointment.student_number || appointment.student_id;
                    document.getElementById('studentName').value = appointment.student_name;
                    document.getElementById('studentName').style.color = 'inherit';
                    
                    // Pre-fill record type based on appointment reason
                    const reason = (appointment.reason || '').toLowerCase();
                    const recordTypeSelect = document.getElementById('recordType');
                    for (let i = 0; i < recordTypeSelect.options.length; i++) {
                        if (reason.includes(recordTypeSelect.options[i].value)) {
                            recordTypeSelect.value = recordTypeSelect.options[i].value;
                            break;
                        }
                    }
                    
                    // Set visit date to appointment date
                    if (appointment.appointment_date) {
                        document.getElementById('visitDate').value = new Date(appointment.appointment_date).toISOString().split('T')[0];
                    }
                }
            } catch (error) {
                console.error('Error fetching appointment info:', error);
            }
        }

        // Handle Add Record Form Submission
        document.getElementById('addRecordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const internalId = document.getElementById('internalStudentId').value;
            const studentName = document.getElementById('studentName').value;
            
            if (!internalId || studentName === 'Student not found') {
                alert('Please enter a valid Student ID and wait for the student information to be found.');
                document.getElementById('studentId').focus();
                return;
            }

            const recordId = document.getElementById('recordId').value;
            const method = recordId ? 'PUT' : 'POST';
            const url = recordId ? `/api/medical-records/${recordId}` : '/api/medical-records';

            const formData = {
                studentId: internalId,
                appointmentId: document.getElementById('appointmentId').value,
                visitDate: document.getElementById('visitDate').value,
                recordType: document.getElementById('recordType').value,
                symptoms: document.getElementById('symptoms').value,
                diagnosis: document.getElementById('diagnosis').value,
                treatment: document.getElementById('treatment').value,
                medications: document.getElementById('medication').value,
                notes: document.getElementById('notes').value,
                followUpRequired: document.getElementById('followUp').value === 'yes'
            };

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert(recordId ? 'Record updated successfully!' : 'Record saved successfully!');
                    hideRecordForm();
                    loadRecords();
                } else {
                    const error = await response.json();
                    alert('Error saving record: ' + error.message);
                }
            } catch (error) {
                console.error('Error saving record:', error);
                alert('Error saving record');
            }
        });

        // Load records on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            
            document.getElementById('searchBtn').addEventListener('click', loadRecords);

            // Hide search icon when typing
            const searchInput = document.getElementById('searchStudent');
            const searchIcon = document.querySelector('.search-icon');
            
            searchInput.addEventListener('input', function() {
                if (this.value.length > 0) {
                    searchIcon.style.display = 'none';
                    this.style.paddingLeft = '15px';
                } else {
                    searchIcon.style.display = 'block';
                    this.style.paddingLeft = '40px';
                }
            });
            
            // If studentId is in URL, auto-open form and populate ID
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdFromUrl = urlParams.get('studentId');
            const appointmentIdFromUrl = urlParams.get('appointmentId');
            
            if (appointmentIdFromUrl) {
                document.getElementById('appointmentId').value = appointmentIdFromUrl;
            }
            
            if (studentIdFromUrl) {
                document.getElementById('studentId').value = studentIdFromUrl;
                showAddRecordForm();
                // fetchStudentInfo will be called by showAddRecordForm -> fetchStudentInfo
            }
        });
    </script>
</body>
</html>