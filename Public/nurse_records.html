<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Records - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html" class="active"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="nurse_scan.html"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Medical Records Management</h2>
                <p class="dashboard-subtitle">Access and manage patient medical records and health information</p>
            </div>

            <!-- Quick Actions -->
            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-plus-circle"></i></div>
                    <h3>Add New Record</h3>
                    <p>Create a new medical record for a patient</p>
                    <button class="btn-primary" onclick="showAddRecordForm()">Add Record</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-search"></i></div>
                    <h3>Search Records</h3>
                    <p>Find patient records by name or ID</p>
                    <button class="btn-primary" onclick="focusSearch()">Search</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-file-export"></i></div>
                    <h3>Export Records</h3>
                    <p>Export medical records for reporting</p>
                    <button class="btn-primary" onclick="exportRecords()">Export</button>
                </div>
                <div class="dashboard-card">
                    <div class="card-icon"><i class="fas fa-history"></i></div>
                    <h3>Recent Activity</h3>
                    <p>View recently accessed records</p>
                    <button class="btn-primary" onclick="showRecentActivity()">View Activity</button>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="search-form">
                <div class="search-row">
                    <div class="search-input-group">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="searchStudent" placeholder="Search by student name, ID, or condition...">
                    </div>
                    <div class="filter-group">
                        <select id="recordTypeFilter" class="filter-select">
                            <option value="">All Record Types</option>
                            <option value="consultation">Consultation</option>
                            <option value="treatment">Treatment</option>
                            <option value="vaccination">Vaccination</option>
                            <option value="emergency">Emergency</option>
                        </select>
                        <select id="dateFilter" class="filter-select">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="week">This Week</option>
                            <option value="month">This Month</option>
                            <option value="year">This Year</option>
                        </select>
                        <button id="searchBtn" class="btn-primary">Search</button>
                        <button id="clearBtn" class="btn-secondary" onclick="clearFilters()">Clear</button>
                    </div>
                </div>
            </div>

            <!-- Records List -->
            <div class="records-list">
                <div class="list-header">
                    <h3>Patient Records</h3>
                    <div class="list-stats">
                        <span id="totalRecords">0</span> records found
                    </div>
                </div>
                <div id="recordsContainer" class="records-grid">
                    <!-- Records will be loaded here -->
                </div>
            </div>

            <!-- Add/Edit Record Form -->
            <div class="record-form" id="recordForm" style="display: none;">
                <div class="form-card">
                    <div class="form-header">
                        <h3 id="formTitle">Add New Medical Record</h3>
                        <p>Enter patient information and medical details</p>
                    </div>
                    <form id="addRecordForm">
                        <input type="hidden" id="recordId" name="recordId">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="studentId">Student ID</label>
                                <input type="text" id="studentId" name="studentId" required>
                            </div>
                            <div class="form-group">
                                <label for="studentName">Student Name</label>
                                <input type="text" id="studentName" name="studentName" readonly>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="recordType">Record Type</label>
                                <select id="recordType" name="recordType" required>
                                    <option value="">Select Type</option>
                                    <option value="consultation">Consultation</option>
                                    <option value="treatment">Treatment</option>
                                    <option value="vaccination">Vaccination</option>
                                    <option value="emergency">Emergency</option>
                                    <option value="follow-up">Follow-up</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="visitDate">Visit Date</label>
                                <input type="date" id="visitDate" name="visitDate" required>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="diagnosis">Diagnosis/Condition</label>
                            <textarea id="diagnosis" name="diagnosis" rows="3" required placeholder="Describe the medical condition or diagnosis"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="treatment">Treatment Provided</label>
                            <textarea id="treatment" name="treatment" rows="3" required placeholder="Describe the treatment administered"></textarea>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="medication">Medication Prescribed</label>
                                <textarea id="medication" name="medication" rows="2" placeholder="List any medications prescribed"></textarea>
                            </div>
                            <div class="form-group">
                                <label for="followUp">Follow-up Required</label>
                                <select id="followUp" name="followUp">
                                    <option value="no">No</option>
                                    <option value="yes">Yes</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="notes">Additional Notes</label>
                            <textarea id="notes" name="notes" rows="3" placeholder="Any additional observations or notes"></textarea>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">Save Record</button>
                            <button type="button" id="cancelBtn" class="btn-secondary" onclick="hideRecordForm()">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Form functions
        function showAddRecordForm() {
            document.getElementById('formTitle').textContent = 'Add New Medical Record';
            document.getElementById('recordForm').style.display = 'block';
            document.getElementById('addRecordForm').reset();
            document.getElementById('studentId').focus();
        }

        function hideRecordForm() {
            document.getElementById('recordForm').style.display = 'none';
            document.getElementById('addRecordForm').reset();
        }

        function focusSearch() {
            document.getElementById('searchStudent').focus();
        }

        function clearFilters() {
            document.getElementById('searchStudent').value = '';
            document.getElementById('recordTypeFilter').value = '';
            document.getElementById('dateFilter').value = '';
            loadRecords();
        }

        function exportRecords() {
            alert('Export functionality coming soon!');
        }

        function showRecentActivity() {
            alert('Recent activity view coming soon!');
        }

        // Load records
        async function loadRecords() {
            const container = document.getElementById('recordsContainer');
            const search = document.getElementById('searchStudent').value;
            const recordType = document.getElementById('recordTypeFilter').value;
            const dateRange = document.getElementById('dateFilter').value;

            // Get studentId from URL if present
            const urlParams = new URLSearchParams(window.location.search);
            const studentIdFromUrl = urlParams.get('studentId');

            try {
                let url = '/api/nurse/students'; // We can use the students list to find records or medical-records endpoint
                // Actually, we want to see records. Let's use the medical-records endpoint if it supports search
                // For now, let's just implement loading records for a specific student if studentId is provided
                
                if (studentIdFromUrl) {
                    const response = await fetch(`/api/medical-records/student/${studentIdFromUrl}`);
                    if (response.ok) {
                        const records = await response.json();
                        displayRecords(records);
                        
                        // Also auto-fill student info if we're adding a new record
                        fetchStudentInfo(studentIdFromUrl);
                    }
                } else {
                    // Load all students the nurse has access to
                    const response = await fetch('/api/nurse/students');
                    if (response.ok) {
                        const students = await response.json();
                        // Maybe we should list students first? 
                        // The current UI expects records. Let's fetch records for all these students.
                        container.innerHTML = '<p>Please search for a student to view their records.</p>';
                    }
                }
            } catch (error) {
                console.error('Error loading records:', error);
                container.innerHTML = '<p>Error loading records</p>';
            }
        }

        function displayRecords(records) {
            const container = document.getElementById('recordsContainer');
            if (records.length === 0) {
                container.innerHTML = '<p>No records found for this student.</p>';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }

            container.innerHTML = records.map(record => `
                <div class="record-card">
                    <div class="record-header">
                        <h4>${record.student_name || 'Patient'}</h4>
                        <span class="record-date">${new Date(record.visit_date).toLocaleDateString()}</span>
                    </div>
                    <div class="record-type">${record.record_type}</div>
                    <div class="record-summary">
                        <p><strong>Diagnosis:</strong> ${record.diagnosis || 'N/A'}</p>
                        <p><strong>Treatment:</strong> ${record.treatment || 'N/A'}</p>
                    </div>
                    <div class="record-actions">
                        <button class="btn-small" onclick="viewRecordDetails(${record.id})">View</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('totalRecords').textContent = records.length;
        }

        async function fetchStudentInfo(studentId) {
            try {
                // We need an endpoint to get student info by their internal ID
                // nurse.js has /students which returns all. Let's see if there is a specific one.
                const response = await fetch('/api/nurse/students');
                if (response.ok) {
                    const students = await response.json();
                    const student = students.find(s => s.id == studentId);
                    if (student) {
                        document.getElementById('studentId').value = student.id;
                        document.getElementById('studentName').value = student.name;
                    }
                }
            } catch (error) {
                console.error('Error fetching student info:', error);
            }
        }

        // Handle Add Record Form Submission
        document.getElementById('addRecordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                studentId: formData.get('studentId'),
                recordType: formData.get('recordType'),
                visitDate: formData.get('visitDate'),
                diagnosis: formData.get('diagnosis'),
                treatment: formData.get('treatment'),
                medications: formData.get('medication'),
                notes: formData.get('notes'),
                followUpRequired: formData.get('followUp') === 'yes' ? 1 : 0
            };

            try {
                const response = await fetch('/api/medical-records', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('Record saved successfully!');
                    hideRecordForm();
                    loadRecords();
                } else {
                    const err = await response.json();
                    alert('Error: ' + err.message);
                }
            } catch (error) {
                alert('Error saving record');
            }
        });

        // Load records on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadRecords();
            
            // If studentId is in URL, auto-open form
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('studentId')) {
                showAddRecordForm();
            }
        });
    </script>
</body>
</html>