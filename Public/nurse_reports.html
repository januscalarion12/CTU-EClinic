<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Reports - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html" class="active"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="nurse_scan.html"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="archive.html"><span class="nav-icon"><i class="fas fa-archive"></i></span><span class="nav-text">Archive</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Reports & Analytics</h2>
                <p class="dashboard-subtitle">Generate comprehensive reports and view clinic performance metrics</p>
            </div>

            <!-- Quick Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                    <div class="stat-content">
                        <h3>This Week</h3>
                        <p id="weeklyAppointments">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <p id="activePatients">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-content">
                        <h3>Avg. Wait Time</h3>
                        <p id="avgWaitTime">...</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-content">
                        <h3>Monthly Trend</h3>
                        <p id="completionRate">0%</p>
                    </div>
                </div>
            </div>

            <!-- Report Categories -->
            <div class="reports-grid">
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
                    <h3>Daily Appointments</h3>
                    <p>View detailed appointments for today with patient information and status</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateDailyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewDailyReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-calendar-week"></i></div>
                    <h3>Weekly Summary</h3>
                    <p>Comprehensive weekly appointment summary with trends and statistics</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateWeeklyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewWeeklyReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-file-medical"></i></div>
                    <h3>Student Health Records</h3>
                    <p>Health records summary with common conditions and treatment patterns</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateHealthReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewHealthReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>Performance Metrics</h3>
                    <p>Clinic performance indicators including wait times and patient satisfaction</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generatePerformanceReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewPerformanceReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-syringe"></i></div>
                    <h3>Vaccination Report</h3>
                    <p>Vaccination records and coverage statistics for the student population</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateVaccinationReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewVaccinationReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3>Emergency Cases</h3>
                    <p>Summary of emergency visits and critical health incidents</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateEmergencyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewEmergencyReport()">Preview</button>
                    </div>
                </div>
            </div>

            <!-- Custom Report Builder -->
            <div class="form-card">
                <div class="form-header">
                    <h3>Custom Report Builder</h3>
                    <p>Create customized reports with specific date ranges and filters</p>
                </div>
                <form id="customReportForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportType">Report Type</label>
                            <select id="reportType" name="reportType" required>
                                <option value="">Select Report Type</option>
                                <option value="appointments">Appointments</option>
                                <option value="records">Medical Records</option>
                                <option value="patients">Patient Demographics</option>
                                <option value="performance">Performance Metrics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateRange">Date Range</label>
                            <select id="dateRange" name="dateRange" required>
                                <option value="">Select Range</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="customDateRange" style="display: none;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Generate Custom Report</button>
                        <button type="button" class="btn-secondary" onclick="resetCustomForm()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Report Output -->
            <div class="report-output" id="reportOutput" style="display: none;">
                <div class="report-header">
                    <h3 id="reportTitle">Report Results</h3>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="printReport()"><i class="fas fa-print"></i> Print</button>
                        <button class="btn-primary" onclick="exportReport()"><i class="fas fa-download"></i> Export PDF</button>
                        <button class="btn-secondary" onclick="emailReport()"><i class="fas fa-envelope"></i> Email</button>
                        <button class="btn-secondary" onclick="closeReport()"><i class="fas fa-times"></i> Close</button>
                    </div>
                </div>
                <div id="reportContent">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/nurse/dashboard-stats', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('weeklyAppointments').textContent = stats.weeklyAppointments || '0';
                    document.getElementById('activePatients').textContent = stats.totalStudents || '0';
                    document.getElementById('completionRate').textContent = (stats.monthlyTrend || 0) + '%';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboardStats);

        // Date range toggle
        document.getElementById('dateRange').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }
        });

        // Report generation functions
        function generateDailyReport() {
            showReport('Daily Appointments Report', 'Generating daily appointments report...');
        }

        function generateWeeklyReport() {
            showReport('Weekly Summary Report', 'Generating weekly summary report...');
        }

        function generateHealthReport() {
            showReport('Student Health Records Report', 'Generating health records report...');
        }

        function generatePerformanceReport() {
            showReport('Performance Metrics Report', 'Generating performance metrics report...');
        }

        function generateVaccinationReport() {
            showReport('Vaccination Report', 'Generating vaccination report...');
        }

        function generateEmergencyReport() {
            showReport('Emergency Cases Report', 'Generating emergency cases report...');
        }

        // Preview functions
        function previewDailyReport() {
            showReport('Daily Appointments Preview', 'Preview of today\'s appointments...');
        }

        function previewWeeklyReport() {
            showReport('Weekly Summary Preview', 'Preview of weekly summary...');
        }

        function previewHealthReport() {
            showReport('Health Records Preview', 'Preview of health records...');
        }

        function previewPerformanceReport() {
            showReport('Performance Preview', 'Preview of performance metrics...');
        }

        function previewVaccinationReport() {
            showReport('Vaccination Preview', 'Preview of vaccination data...');
        }

        function previewEmergencyReport() {
            showReport('Emergency Preview', 'Preview of emergency cases...');
        }

        // Utility functions
        // Generate Custom Report
        document.getElementById('customReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const reportType = formData.get('reportType');
            const dateRange = formData.get('dateRange');
            let startDate = formData.get('startDate');
            let endDate = formData.get('endDate');

            if (dateRange !== 'custom') {
                const now = new Date();
                endDate = now.toISOString().split('T')[0];
                if (dateRange === 'today') startDate = endDate;
                else if (dateRange === 'week') startDate = new Date(now.setDate(now.getDate() - 7)).toISOString().split('T')[0];
                else if (dateRange === 'month') startDate = new Date(now.setMonth(now.getMonth() - 1)).toISOString().split('T')[0];
                else if (dateRange === 'year') startDate = new Date(now.setFullYear(now.getFullYear() - 1)).toISOString().split('T')[0];
            }

            try {
                let endpoint = reportType === 'appointments' ? '/api/reports/appointments' : '/api/reports/medical-records';
                const response = await fetch(`${endpoint}?startDate=${startDate}&endDate=${endDate}`);
                if (response.ok) {
                    const result = await response.json();
                    displayReportResults(result);
                } else {
                    alert('Error generating report');
                }
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function displayReportResults(result) {
            const container = document.getElementById('reportContent');
            const data = result.data;
            
            if (!data || data.length === 0) {
                container.innerHTML = '<p>No data found for the selected criteria.</p>';
            } else {
                let html = '<table class="report-table"><thead><tr>';
                const keys = Object.keys(data[0]);
                keys.forEach(key => html += `<th>${key.replace(/_/g, ' ').toUpperCase()}</th>`);
                html += '</tr></thead><tbody>';
                
                data.forEach(row => {
                    html += '<tr>';
                    keys.forEach(key => {
                        let val = row[key];
                        if (key.includes('date') || key.includes('_at')) val = new Date(val).toLocaleDateString();
                        html += `<td>${val || ''}</td>`;
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table>';
                container.innerHTML = html;
                
                // Add Download CSV button
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn-primary';
                downloadBtn.innerHTML = '<i class="fas fa-file-csv"></i> Download CSV';
                downloadBtn.onclick = () => downloadCSV(data, result.reportType);
                document.querySelector('.report-header .report-actions').prepend(downloadBtn);
            }
            
            document.getElementById('reportOutput').style.display = 'block';
        }

        function downloadCSV(data, title) {
            const csvRows = [];
            const headers = Object.keys(data[0]);
            csvRows.push(headers.join(','));

            for (const row of data) {
                const values = headers.map(header => {
                    const escaped = ('' + row[header]).replace(/"/g, '\\"');
                    return `"${escaped}"`;
                });
                csvRows.push(values.join(','));
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function printReport() {
            window.print();
        }

        function exportReport() {
            alert('PDF export functionality coming soon!');
        }

        function emailReport() {
            alert('Email functionality coming soon!');
        }

        function resetCustomForm() {
            document.getElementById('customReportForm').reset();
            document.getElementById('customDateRange').style.display = 'none';
        }

    </script>
</body>
</html>