<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nurse Reports - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .report-table th, .report-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        .report-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #333;
            text-transform: uppercase;
            font-size: 0.85rem;
        }
        .report-table tr:hover {
            background-color: #f1f4f8;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        
        .report-loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        .report-loading i {
            font-size: 2rem;
            margin-bottom: 10px;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>CTU Bantayan E-Clinic</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html" class="active"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="nurse_scan.html"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="archive.html"><span class="nav-icon"><i class="fas fa-archive"></i></span><span class="nav-text">Archive</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>Reports & Analytics</h2>
                <p class="dashboard-subtitle">Generate comprehensive reports and view clinic performance metrics</p>
            </div>

            <!-- Quick Stats -->
            <div class="dashboard-stats">
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-calendar-week"></i></div>
                    <div class="stat-content">
                        <h3>This Week</h3>
                        <p id="weeklyAppointments">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-users"></i></div>
                    <div class="stat-content">
                        <h3>Total Students</h3>
                        <p id="activeStudents">0</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-clock"></i></div>
                    <div class="stat-content">
                        <h3>Avg. Wait Time</h3>
                        <p id="avgWaitTime">...</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon"><i class="fas fa-check-circle"></i></div>
                    <div class="stat-content">
                        <h3>Monthly Trend</h3>
                        <p id="completionRate">0%</p>
                    </div>
                </div>
            </div>

            <!-- Report Categories -->
            <div class="reports-grid">
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-calendar-day"></i></div>
                    <h3>Daily Appointments</h3>
                    <p>View detailed appointments for today with student information and status</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateDailyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewDailyReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-calendar-week"></i></div>
                    <h3>Weekly Summary</h3>
                    <p>Comprehensive weekly appointment summary with trends and statistics</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateWeeklyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewWeeklyReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-file-medical"></i></div>
                    <h3>Student Health Records</h3>
                    <p>Health records summary with common conditions and treatment patterns</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateHealthReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewHealthReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                    <h3>Performance Metrics</h3>
                    <p>Clinic performance indicators including wait times and student satisfaction</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generatePerformanceReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewPerformanceReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-syringe"></i></div>
                    <h3>Vaccination Report</h3>
                    <p>Vaccination records and coverage statistics for the student population</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateVaccinationReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewVaccinationReport()">Preview</button>
                    </div>
                </div>
                <div class="report-card">
                    <div class="card-icon"><i class="fas fa-exclamation-triangle"></i></div>
                    <h3>Emergency Cases</h3>
                    <p>Summary of emergency visits and critical health incidents</p>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="generateEmergencyReport()">Generate Report</button>
                        <button class="btn-secondary" onclick="previewEmergencyReport()">Preview</button>
                    </div>
                </div>
            </div>

            <!-- Custom Report Builder -->
            <div class="form-card">
                <div class="form-header">
                    <h3>Custom Report Builder</h3>
                    <p>Create customized reports with specific date ranges and filters</p>
                </div>
                <form id="customReportForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="reportType">Report Type</label>
                            <select id="reportType" name="reportType" required>
                                <option value="">Select Report Type</option>
                                <option value="appointments">Appointments</option>
                                <option value="records">Medical Records</option>
                                <option value="patients">Student Demographics</option>
                                <option value="performance">Performance Metrics</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="dateRange">Date Range</label>
                            <select id="dateRange" name="dateRange" required>
                                <option value="">Select Range</option>
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                                <option value="custom">Custom Range</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row" id="customDateRange" style="display: none;">
                        <div class="form-group">
                            <label for="startDate">Start Date</label>
                            <input type="date" id="startDate" name="startDate">
                        </div>
                        <div class="form-group">
                            <label for="endDate">End Date</label>
                            <input type="date" id="endDate" name="endDate">
                        </div>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Generate Custom Report</button>
                        <button type="button" class="btn-secondary" onclick="resetCustomForm()">Reset</button>
                    </div>
                </form>
            </div>

            <!-- Report Output -->
            <div class="report-output" id="reportOutput" style="display: none;">
                <div class="report-header">
                    <h3 id="reportTitle">Report Results</h3>
                    <div class="report-actions">
                        <button class="btn-primary" onclick="printReport()"><i class="fas fa-print"></i> Print</button>
                        <button class="btn-primary" onclick="exportReport()"><i class="fas fa-download"></i> Export PDF</button>
                        <button class="btn-secondary" onclick="emailReport()"><i class="fas fa-envelope"></i> Email</button>
                        <button class="btn-secondary" onclick="closeReport()"><i class="fas fa-times"></i> Close</button>
                    </div>
                </div>
                <div id="reportContent">
                    <!-- Report content will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        async function loadDashboardStats() {
            try {
                const response = await fetch('/api/nurse/dashboard-stats', {
                    credentials: 'include'
                });
                if (response.ok) {
                    const stats = await response.json();
                    document.getElementById('weeklyAppointments').textContent = stats.weeklyAppointments || '0';
                    document.getElementById('activeStudents').textContent = stats.totalStudents || '0';
                    document.getElementById('completionRate').textContent = (stats.monthlyTrend || 0) + '%';
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', loadDashboardStats);

        // Date range toggle
        document.getElementById('dateRange').addEventListener('change', function() {
            const customRange = document.getElementById('customDateRange');
            if (this.value === 'custom') {
                customRange.style.display = 'flex';
            } else {
                customRange.style.display = 'none';
            }
        });

        // Report generation functions
        async function fetchAndDisplayReport(endpoint, params = {}, title) {
            const container = document.getElementById('reportContent');
            const output = document.getElementById('reportOutput');
            const titleElem = document.getElementById('reportTitle');
            
            output.style.display = 'block';
            titleElem.textContent = title;
            container.innerHTML = '<div class="report-loading"><i class="fas fa-spinner fa-spin"></i>Generating report...</div>';
            
            try {
                const queryParams = new URLSearchParams(params).toString();
                const response = await fetch(`${endpoint}${queryParams ? '?' + queryParams : ''}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    displayReportResults(result);
                    // Scroll to report output
                    output.scrollIntoView({ behavior: 'smooth' });
                } else {
                    const error = await response.json();
                    container.innerHTML = `<p class="error">Error: ${error.message || 'Failed to generate report'}</p>`;
                }
            } catch (error) {
                console.error('Error:', error);
                container.innerHTML = '<p class="error">Error: Network error or server is down.</p>';
            }
        }

        function generateDailyReport() {
            const today = new Date().toISOString().split('T')[0];
            fetchAndDisplayReport('/api/reports/appointments', { startDate: today, endDate: today }, 'Daily Appointments Report');
        }

        function generateWeeklyReport() {
            const now = new Date();
            const start = new Date(now.setDate(now.getDate() - 7)).toISOString().split('T')[0];
            const end = new Date().toISOString().split('T')[0];
            fetchAndDisplayReport('/api/reports/appointments', { startDate: start, endDate: end }, 'Weekly Summary Report');
        }

        function generateHealthReport() {
            fetchAndDisplayReport('/api/reports/medical-records', {}, 'Student Health Records Report');
        }

        function generatePerformanceReport() {
            // Reusing statistics as a performance overview for now
            fetchAndDisplayReport('/api/reports/statistics', { period: 'month' }, 'Performance Metrics Report');
        }

        function generateVaccinationReport() {
            fetchAndDisplayReport('/api/reports/medical-records', { recordType: 'vaccination' }, 'Vaccination Report');
        }

        function generateEmergencyReport() {
            fetchAndDisplayReport('/api/reports/medical-records', { recordType: 'emergency' }, 'Emergency Cases Report');
        }

        // Preview functions (using same functions as generate for now)
        function previewDailyReport() { generateDailyReport(); }
        function previewWeeklyReport() { generateWeeklyReport(); }
        function previewHealthReport() { generateHealthReport(); }
        function previewPerformanceReport() { generatePerformanceReport(); }
        function previewVaccinationReport() { generateVaccinationReport(); }
        function previewEmergencyReport() { generateEmergencyReport(); }

        function showReport(title, message) {
            document.getElementById('reportTitle').textContent = title;
            document.getElementById('reportContent').innerHTML = `<p>${message}</p>`;
            document.getElementById('reportOutput').style.display = 'block';
        }

        // Utility functions
        // Generate Custom Report
        document.getElementById('customReportForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const reportType = formData.get('reportType');
            const dateRange = formData.get('dateRange');
            let startDate = formData.get('startDate');
            let endDate = formData.get('endDate');

            if (dateRange !== 'custom' && dateRange !== '') {
                const now = new Date();
                endDate = new Date().toISOString().split('T')[0];
                if (dateRange === 'today') {
                    startDate = endDate;
                } else if (dateRange === 'week') {
                    startDate = new Date(now.setDate(now.getDate() - 7)).toISOString().split('T')[0];
                } else if (dateRange === 'month') {
                    startDate = new Date(now.setMonth(now.getMonth() - 1)).toISOString().split('T')[0];
                } else if (dateRange === 'year') {
                    startDate = new Date(now.setFullYear(now.getFullYear() - 1)).toISOString().split('T')[0];
                }
            }

            const params = { startDate, endDate };
            let endpoint = '/api/reports/appointments';
            let title = 'Custom Appointments Report';

            if (reportType === 'records') {
                endpoint = '/api/reports/medical-records';
                title = 'Custom Medical Records Report';
            } else if (reportType === 'patients') {
                endpoint = '/api/reports/students';
                title = 'Student Demographics Report';
            } else if (reportType === 'performance') {
                endpoint = '/api/reports/statistics';
                title = 'Performance Statistics Report';
            }

            fetchAndDisplayReport(endpoint, params, title);
        });

        function displayReportResults(result) {
            const container = document.getElementById('reportContent');
            const data = result.data || result.statistics;
            const reportType = result.reportType || (result.statistics ? 'Statistics Report' : 'Report');
            
            if (!data || (Array.isArray(data) && data.length === 0)) {
                container.innerHTML = '<p>No data found for the selected criteria.</p>';
            } else if (!Array.isArray(data)) {
                // Handle statistics object
                let html = '<div class="stats-summary">';
                html += '<table class="report-table"><tbody>';
                for (const [key, value] of Object.entries(data)) {
                    html += `<tr><th>${key.replace(/([A-Z])/g, ' $1').toUpperCase()}</th><td>${value}</td></tr>`;
                }
                html += '</tbody></table></div>';
                container.innerHTML = html;
            } else {
                // Handle data array
                let html = '<div class="table-responsive"><table class="report-table"><thead><tr>';
                
                // Define columns to show to avoid showing internal IDs and keep it clean
                const allKeys = Object.keys(data[0]);
                const excludedKeys = ['id', 'user_id', 'nurse_id', 'student_id_internal', 'qr_code'];
                const keys = allKeys.filter(k => !excludedKeys.includes(k.toLowerCase()));
                
                keys.forEach(key => html += `<th>${key.replace(/_/g, ' ').toUpperCase()}</th>`);
                html += '</tr></thead><tbody>';
                
                data.forEach(row => {
                    html += '<tr>';
                    keys.forEach(key => {
                        let val = row[key];
                        if (key.toLowerCase().includes('date') || key.toLowerCase().includes('_at')) {
                            val = val ? new Date(val).toLocaleDateString() : 'N/A';
                        }
                        if (key.toLowerCase() === 'status') {
                            html += `<td><span class="status-badge status-${val.toLowerCase()}">${val}</span></td>`;
                        } else {
                            html += `<td>${val === null || val === undefined ? '' : val}</td>`;
                        }
                    });
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                container.innerHTML = html;
                
                // Add Download CSV button
                const actionContainer = document.querySelector('.report-header .report-actions');
                // Remove existing CSV button if any
                const oldCsvBtn = actionContainer.querySelector('.btn-csv');
                if (oldCsvBtn) oldCsvBtn.remove();
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'btn-primary btn-csv';
                downloadBtn.innerHTML = '<i class="fas fa-file-csv"></i> Download CSV';
                downloadBtn.onclick = () => downloadCSV(data, reportType);
                actionContainer.prepend(downloadBtn);
            }
            
            document.getElementById('reportOutput').style.display = 'block';
        }

        function downloadCSV(data, title) {
            const csvRows = [];
            
            if (Array.isArray(data)) {
                const headers = Object.keys(data[0]);
                csvRows.push(headers.join(','));

                for (const row of data) {
                    const values = headers.map(header => {
                        const val = row[header];
                        const escaped = ('' + (val === null || val === undefined ? '' : val)).replace(/"/g, '\\"');
                        return `"${escaped}"`;
                    });
                    csvRows.push(values.join(','));
                }
            } else {
                // Statistics object
                csvRows.push('Metric,Value');
                for (const [key, value] of Object.entries(data)) {
                    csvRows.push(`${key.replace(/([A-Z])/g, ' $1')},${value}`);
                }
            }

            const blob = new Blob([csvRows.join('\n')], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', `${title.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function printReport() {
            window.print();
        }

        function exportReport() {
            alert('PDF export functionality coming soon!');
        }

        function emailReport() {
            alert('Email functionality coming soon!');
        }

        function resetCustomForm() {
            document.getElementById('customReportForm').reset();
            document.getElementById('customDateRange').style.display = 'none';
        }

        function closeReport() {
            document.getElementById('reportOutput').style.display = 'none';
        }

    </script>
</body>
</html>