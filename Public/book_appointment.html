<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">Student User</span>
                <span class="user-role">Student</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="notifications.html" class="dropdown-item">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="student.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="book_appointment.html" class="active"><span class="nav-icon"><i class="fas fa-calendar-plus"></i></span><span class="nav-text">Book Appointment</span></a></li>
                <li><a href="appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">My Appointments</span></a></li>
                <li><a href="medical-records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="notifications.html"><span class="nav-icon"><i class="fas fa-bell"></i></span><span class="nav-text">Notifications</span></a></li>
                
            </ul>
        </div>
    </nav>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h2>Book Appointment</h2>
            <div class="appointment-form">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="appointmentDate">Preferred Date</label>
                        <input type="date" id="appointmentDate" name="appointmentDate" required>
                        <div id="dateAvailability" class="availability-info"></div>
                    </div>
                    <div class="form-group">
                        <label for="nurseSelect">Select Nurse</label>
                        <select id="nurseSelect" name="nurseSelect" required>
                            <option value="">Select Date First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="appointmentTime">Available Time Slots</label>
                        <select id="appointmentTime" name="appointmentTime" required>
                            <option value="">Select Nurse First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="reason">Reason for Visit</label>
                        <textarea id="reason" name="reason" placeholder="Brief description of your health concern" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Book Appointment</button>
                </form>
            </div>

            <div class="available-slots" id="availableSlots" style="display: none;">
                <h3>Available Time Slots</h3>
                <div id="slotsContainer">
                    <!-- Available slots will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Form submission handler
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const nurseId = formData.get('nurseSelect');
            const appointmentTime = formData.get('appointmentTime');

            if (!nurseId || !appointmentTime) {
                alert('Please select a nurse and time slot');
                return;
            }

            // Check if selected time slot is available
            const selectedOption = document.querySelector('#appointmentTime option:checked');
            if (selectedOption && selectedOption.disabled) {
                alert('This time slot is fully booked. Please select a different time.');
                return;
            }

            const appointmentData = {
                nurseId: parseInt(nurseId),
                appointmentDate: formData.get('appointmentDate') + 'T' + appointmentTime,
                reason: formData.get('reason')
            };

            try {
                const response = await fetch('/api/student/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include', // Use session cookies instead of localStorage
                    body: JSON.stringify(appointmentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Appointment booked successfully! Your appointment is pending nurse approval.');
                    this.reset();
                    resetForm();
                } else {
                    const error = await response.json();
                    alert('Error booking appointment: ' + error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error booking appointment');
            }
        });

        // Date change handler
        document.getElementById('appointmentDate').addEventListener('change', async function() {
            const selectedDate = this.value;
            if (selectedDate) {
                await loadAvailableNurses(selectedDate);
            } else {
                resetForm();
            }
        });

        // Nurse change handler
        document.getElementById('nurseSelect').addEventListener('change', async function() {
            const selectedNurseId = this.value;
            const selectedDate = document.getElementById('appointmentDate').value;
            if (selectedNurseId && selectedDate) {
                await loadAvailableSlots(selectedNurseId, selectedDate);
            } else {
                resetTimeSlots();
            }
        });

        // Load available nurses for selected date
        async function loadAvailableNurses(date) {
            const nurseSelect = document.getElementById('nurseSelect');
            const availabilityInfo = document.getElementById('dateAvailability');

            try {
                const response = await fetch(`/api/student/availability?date=${date}`, {
                    method: 'GET',
                    credentials: 'include' // Use session cookies instead of localStorage
                });

                if (response.ok) {
                    const slots = await response.json();

                    if (slots.length === 0) {
                        availabilityInfo.innerHTML = '<span class="no-availability">No nurses available on this date</span>';
                        nurseSelect.innerHTML = '<option value="">No nurses available</option>';
                        nurseSelect.disabled = true;
                        resetTimeSlots();
                        return;
                    }

                    // Get unique nurses
                    const uniqueNurses = [];
                    const nurseMap = new Map();

                    slots.forEach(slot => {
                        if (!nurseMap.has(slot.nurse_id)) {
                            nurseMap.set(slot.nurse_id, slot.nurse_name);
                            uniqueNurses.push({
                                id: slot.nurse_id,
                                name: slot.nurse_name
                            });
                        }
                    });

                    availabilityInfo.innerHTML = `<span class="available-info">${uniqueNurses.length} nurse(s) available</span>`;

                    nurseSelect.innerHTML = '<option value="">Select Nurse</option>' +
                        uniqueNurses.map(nurse => `<option value="${nurse.id}">${nurse.name}</option>`).join('');
                    nurseSelect.disabled = false;

                } else if (response.status === 403) {
                    availabilityInfo.innerHTML = '<span class="error-info">Session expired. Please login again.</span>';
                    resetForm();
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    setTimeout(() => window.location.href = 'login.html', 2000);
                } else {
                    availabilityInfo.innerHTML = '<span class="error-info">Error loading availability</span>';
                    resetForm();
                }
            } catch (error) {
                console.error('Error loading availability:', error);
                availabilityInfo.innerHTML = '<span class="error-info">Error loading availability</span>';
                resetForm();
            }
        }

        // Load available time slots for selected nurse and date
        async function loadAvailableSlots(nurseId, date) {
            const timeSelect = document.getElementById('appointmentTime');

            try {
                const response = await fetch(`/api/student/availability?date=${date}`, {
                    method: 'GET',
                    credentials: 'include' // Use session cookies instead of localStorage
                });

                if (response.ok) {
                    const slots = await response.json();

                    // Filter slots for the selected nurse
                    const nurseSlots = slots.filter(slot => slot.nurse_id == nurseId);

                    if (nurseSlots.length === 0) {
                        timeSelect.innerHTML = '<option value="">No slots available</option>';
                        timeSelect.disabled = true;
                        return;
                    }

                    // Generate time slots from nurse availability
                    const timeSlots = generateTimeSlots(nurseSlots);
                    timeSelect.innerHTML = '<option value="">Select Time</option>' +
                        timeSlots.map(slot => `<option value="${slot.value}" ${!slot.available ? 'disabled style="color: #999;"' : ''}>${slot.label}${!slot.available ? ' (FULLY BOOKED)' : ''}</option>`).join('');
                    timeSelect.disabled = false;

                } else {
                    timeSelect.innerHTML = '<option value="">Error loading slots</option>';
                    timeSelect.disabled = true;
                }
            } catch (error) {
                console.error('Error loading slots:', error);
                timeSelect.innerHTML = '<option value="">Error loading slots</option>';
                timeSelect.disabled = true;
            }
        }

        function generateTimeSlots(availabilitySlots) {
            const slots = [];
            const slotDuration = 60; // 60 minutes per slot

            availabilitySlots.forEach(slot => {
                const startTime = new Date(`2000-01-01T${slot.start_time}`);
                const endTime = new Date(`2000-01-01T${slot.end_time}`);

                let currentTime = new Date(startTime);

                while (currentTime < endTime) {
                    const slotEnd = new Date(currentTime.getTime() + slotDuration * 60000);

                    if (slotEnd <= endTime) {
                        const timeValue = currentTime.toTimeString().slice(0, 5);
                        const availableSlots = slot.max_patients - slot.booked_slots;
                        const timeLabel = `${currentTime.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        })} - ${slotEnd.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        })} (${availableSlots} slots available)`;

                        // Add all slots but mark unavailable ones
                        slots.push({
                            value: timeValue,
                            label: timeLabel,
                            nurseId: slot.nurse_id,
                            available: availableSlots > 0
                        });
                    }

                    currentTime = slotEnd;
                }
            });

            return slots;
        }

        function resetTimeSlots() {
            const timeSelect = document.getElementById('appointmentTime');
            timeSelect.innerHTML = '<option value="">Select Nurse First</option>';
            timeSelect.disabled = true;
        }

        function resetForm() {
            const nurseSelect = document.getElementById('nurseSelect');
            nurseSelect.innerHTML = '<option value="">Select Date First</option>';
            nurseSelect.disabled = true;
            resetTimeSlots();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Set minimum date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('appointmentDate').setAttribute('min', today);

            resetForm();
        });
    </script>
</body>
</html>