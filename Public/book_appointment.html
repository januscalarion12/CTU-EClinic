<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Appointment - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">Student User</span>
                <span class="user-role">Student</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-graduation-cap"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="notifications.html" class="dropdown-item">
                    <i class="fas fa-bell"></i> Notifications
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="student.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="book_appointment.html" class="active"><span class="nav-icon"><i class="fas fa-calendar-plus"></i></span><span class="nav-text">Book Appointment</span></a></li>
                <li><a href="appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">My Appointments</span></a></li>
                <li><a href="medical-records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="notifications.html"><span class="nav-icon"><i class="fas fa-bell"></i></span><span class="nav-text">Notifications</span></a></li>
                
            </ul>
        </div>
    </nav>

    <!-- Sidebar Toggle Button -->
    <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h2>Book Appointment</h2>
            <div class="appointment-form">
                <form id="appointmentForm">
                    <div class="form-group">
                        <label for="calendar">Select Date and Time</label>
                        <div id='calendar'></div>
                        <input type="hidden" id="appointmentDate" name="appointmentDate">
                        <input type="hidden" id="appointmentTime" name="appointmentTime">
                        <input type="hidden" id="nurseId" name="nurseId">
                    </div>
                    <div class="form-group">
                        <label for="reason">Reason for Visit</label>
                        <textarea id="reason" name="reason" placeholder="Brief description of your health concern" required></textarea>
                    </div>
                    <button type="submit" class="btn-primary">Book Appointment</button>
                </form>
            </div>

            <div class="available-slots" id="availableSlots" style="display: none;">
                <h3>Available Time Slots</h3>
                <div id="slotsContainer">
                    <!-- Available slots will be displayed here -->
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="js/common.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        let calendar;
        let selectedDate = null;
        let selectedTime = null;
        let selectedNurseId = null;

        // Initialize calendar
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                selectable: true,
                dateClick: function(info) {
                    const dateStr = info.dateStr;
                    if (window.availableDates && window.availableDates.includes(dateStr)) {
                        selectedDate = dateStr;
                        loadAvailableSlots(selectedDate);
                    } else {
                        alert('This date is not available for appointments.');
                    }
                },
                events: async function(fetchInfo, successCallback, failureCallback) {
                    try {
                        const startStr = fetchInfo.start.toISOString().split('T')[0];
                        const endStr = fetchInfo.end.toISOString().split('T')[0];
                        const response = await fetch(`/api/student/available-dates?start=${startStr}&end=${endStr}`, {
                            method: 'GET',
                            credentials: 'include'
                        });

                        if (response.ok) {
                            const availableDates = await response.json();
                            window.availableDates = availableDates;

                            // Create background events for all dates
                            const events = [];
                            let current = new Date(fetchInfo.start);
                            const end = new Date(fetchInfo.end);

                            while (current < end) {
                                const dateStr = current.toISOString().split('T')[0];
                                const isAvailable = availableDates.includes(dateStr);
                                events.push({
                                    start: dateStr,
                                    rendering: 'background',
                                    backgroundColor: isAvailable ? '#d4edda' : '#f8d7da',
                                    borderColor: isAvailable ? '#28a745' : '#dc3545'
                                });
                                current.setDate(current.getDate() + 1);
                            }

                            successCallback(events);
                        } else {
                            failureCallback('Error loading dates');
                        }
                    } catch (error) {
                        console.error('Error loading available dates:', error);
                        failureCallback(error);
                    }
                }
            });
            calendar.render();
        });


        // Load available time slots for selected date
        async function loadAvailableSlots(date) {
            const slotsContainer = document.getElementById('slotsContainer');
            const availableSlots = document.getElementById('availableSlots');

            try {
                const response = await fetch(`/api/student/availability?date=${date}`, {
                    method: 'GET',
                    credentials: 'include'
                });

                if (response.ok) {
                    const slots = await response.json();

                    if (slots.length === 0) {
                        slotsContainer.innerHTML = '<p>No slots available on this date</p>';
                        availableSlots.style.display = 'block';
                        return;
                    }

                    // Generate time slots
                    const timeSlots = generateTimeSlots(slots);
                    slotsContainer.innerHTML = timeSlots.map(slot => `
                        <button type="button" class="time-slot ${slot.available ? 'available' : 'booked'}"
                                data-time="${slot.value}" data-nurse="${slot.nurseId}"
                                ${!slot.available ? 'disabled' : ''}>
                            ${slot.label}
                        </button>
                    `).join('');

                    // Add click handlers
                    document.querySelectorAll('.time-slot.available').forEach(button => {
                        button.addEventListener('click', function() {
                            // Remove selected class from others
                            document.querySelectorAll('.time-slot').forEach(btn => btn.classList.remove('selected'));
                            this.classList.add('selected');
                            selectedTime = this.dataset.time;
                            selectedNurseId = this.dataset.nurse;
                            document.getElementById('appointmentDate').value = date;
                            document.getElementById('appointmentTime').value = selectedTime;
                            document.getElementById('nurseId').value = selectedNurseId;
                        });
                    });

                    availableSlots.style.display = 'block';

                } else {
                    slotsContainer.innerHTML = '<p>Error loading slots</p>';
                    availableSlots.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading slots:', error);
                slotsContainer.innerHTML = '<p>Error loading slots</p>';
                availableSlots.style.display = 'block';
            }
        }

        function generateTimeSlots(availabilitySlots) {
            const slots = [];
            const slotDuration = 60; // 60 minutes per slot

            availabilitySlots.forEach(slot => {
                const startTime = new Date(`2000-01-01T${slot.start_time}`);
                const endTime = new Date(`2000-01-01T${slot.end_time}`);

                let currentTime = new Date(startTime);

                while (currentTime < endTime) {
                    const slotEnd = new Date(currentTime.getTime() + slotDuration * 60000);

                    if (slotEnd <= endTime) {
                        const timeValue = currentTime.toTimeString().slice(0, 5);
                        const availableSlots = slot.max_patients - slot.booked_slots;
                        const timeLabel = `${currentTime.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        })} - ${slotEnd.toLocaleTimeString('en-US', {
                            hour: 'numeric',
                            minute: '2-digit',
                            hour12: true
                        })} (${availableSlots} slots available)`;

                        slots.push({
                            value: timeValue,
                            label: timeLabel,
                            nurseId: slot.nurse_id,
                            available: availableSlots > 0
                        });
                    }

                    currentTime = slotEnd;
                }
            });

            return slots;
        }

        // Form submission handler
        document.getElementById('appointmentForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!selectedDate || !selectedTime || !selectedNurseId) {
                alert('Please select a date and time slot');
                return;
            }

            const appointmentData = {
                nurseId: parseInt(selectedNurseId),
                appointmentDate: selectedDate + 'T' + selectedTime,
                reason: document.getElementById('reason').value
            };

            try {
                const response = await fetch('/api/student/bookings', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify(appointmentData)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('Appointment booked successfully! Your appointment is pending nurse approval.');
                    this.reset();
                    selectedDate = null;
                    selectedTime = null;
                    selectedNurseId = null;
                    document.getElementById('availableSlots').style.display = 'none';
                    calendar.refetchEvents();
                } else {
                    const error = await response.json();
                    alert('Error booking appointment: ' + error.message);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error booking appointment');
            }
        });
    </script>
</body>
</html>