<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="scanner.html" class="active"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>QR Code Scanner</h2>
                <p class="dashboard-subtitle">Scan student QR codes for quick check-in</p>
            </div>

            <div class="scanner-container">
                <div class="scanner-section">
                    <div class="scanner-viewport">
                        <div id="scanner" class="scanner-active">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                        </div>
                        <div id="scannerPlaceholder" class="scanner-placeholder" style="display: none;">
                            <div class="placeholder-content">
                                <i class="fas fa-camera"></i>
                                <p>Camera access required</p>
                                <button class="btn-primary" onclick="requestCameraAccess()">Enable Camera</button>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-controls">
                        <button id="startScan" class="btn-primary">
                            <i class="fas fa-play"></i> Start Scanning
                        </button>
                        <button id="stopScan" class="btn-secondary" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Scanning
                        </button>
                    </div>
                </div>

                <div class="scan-result" id="scanResult" style="display: none;">
                    <h3><i class="fas fa-check-circle"></i> Scan Successful</h3>
                    <div id="studentInfo" class="student-card">
                        <!-- Student info will be injected here -->
                    </div>
                    <div class="scan-actions">
                        <button id="viewRecord" class="btn-primary">View Records</button>
                        <button id="closeResult" class="btn-secondary">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2024 Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        // Scanner variables
        let stream = null;
        let scanning = false;
        let video = document.getElementById('video');
        let canvas = document.getElementById('canvas');
        let canvasContext = canvas.getContext('2d');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', function() {
                document.getElementById('sidebar').classList.toggle('collapsed');
                if (window.innerWidth <= 768) {
                    document.getElementById('sidebar').classList.toggle('mobile-open');
                    document.getElementById('sidebarOverlay').classList.toggle('active');
                }
            });

            document.getElementById('sidebarOverlay').addEventListener('click', function() {
                document.getElementById('sidebar').classList.remove('mobile-open');
                this.classList.remove('active');
            });
        });

        async function requestCameraAccess() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                document.getElementById('scannerPlaceholder').style.display = 'none';
                document.getElementById('scanner').style.display = 'block';
                return true;
            } catch (err) {
                console.error("Camera access error:", err);
                alert("Could not access camera. Please ensure you have granted permission.");
                return false;
            }
        }

        document.getElementById('startScan').addEventListener('click', async function() {
            if (!stream) {
                const success = await requestCameraAccess();
                if (!success) return;
            }
            startScanning();
        });

        document.getElementById('stopScan').addEventListener('click', stopScanning);
        document.getElementById('closeResult').addEventListener('click', () => {
            document.getElementById('scanResult').style.display = 'none';
        });

        function startScanning() {
            scanning = true;
            document.getElementById('startScan').style.display = 'none';
            document.getElementById('stopScan').style.display = 'inline-block';
            requestAnimationFrame(scanFrame);
        }

        function stopScanning() {
            scanning = false;
            document.getElementById('startScan').style.display = 'inline-block';
            document.getElementById('stopScan').style.display = 'none';
        }

        function scanFrame() {
            if (!scanning) return;

            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.height = video.videoHeight;
                canvas.width = video.videoWidth;
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });

                if (code) {
                    processQRCode(code.data);
                    stopScanning();
                    return;
                }
            }
            requestAnimationFrame(scanFrame);
        }

        async function processQRCode(data) {
            try {
                const response = await fetch('/api/nurse/scan-appointment-qr', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ qrData: data })
                });

                const result = await response.json();

                if (response.ok) {
                    showResult(result.appointment);
                } else {
                    alert("Scan failed: " + result.message);
                }
            } catch (err) {
                console.error("Processing error:", err);
                alert("Error connecting to server.");
            }
        }

        function showResult(appointment) {
            const info = document.getElementById('studentInfo');
            info.innerHTML = `
                <p><strong>Student Name:</strong> ${appointment.studentName || 'Unknown Student'}</p>
                <p><strong>Student ID:</strong> ${appointment.studentId || 'N/A'}</p>
                <p><strong>Status:</strong> ${appointment.status || 'N/A'}</p>
            `;
            document.getElementById('scanResult').style.display = 'block';
            document.getElementById('viewRecord').onclick = () => {
                window.location.href = `nurse_records.html?studentId=${appointment.studentInternalId}`;
            };
        }

        // Cleanup
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
