<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Scanner - Clinic Management System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <!-- Top Header -->
    <header class="top-header">
        <div class="user-profile" id="userProfile">
            <div class="user-info">
                <span class="user-name" id="userName">...</span>
                <span class="user-role" id="userRole">...</span>
            </div>
            <div class="user-avatar">
                <i class="fas fa-user-nurse"></i>
            </div>
            <button class="dropdown-toggle" id="dropdownToggle">
                <i class="fas fa-chevron-down"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
                <a href="nurse_profile.html" class="dropdown-item">
                    <i class="fas fa-user"></i> Profile
                </a>
                <a href="nurse_availability.html" class="dropdown-item">
                    <i class="fas fa-clock"></i> Availability
                </a>
                <a href="#" class="dropdown-item" id="logout">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggle">
            <i class="fas fa-bars"></i>
        </button>
    </header>

    <!-- Sidebar Navigation -->
    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>Clinic Management</h1>
        </div>
        <div class="sidebar-nav">
            <ul>
                <li><a href="nurse_dashboard.html"><span class="nav-icon"><i class="fas fa-tachometer-alt"></i></span><span class="nav-text">Dashboard</span></a></li>
                <li><a href="nurse_appointments.html"><span class="nav-icon"><i class="fas fa-calendar-check"></i></span><span class="nav-text">Appointments</span></a></li>
                <li><a href="nurse_records.html"><span class="nav-icon"><i class="fas fa-file-medical"></i></span><span class="nav-text">Medical Records</span></a></li>
                <li><a href="nurse_availability.html"><span class="nav-icon"><i class="fas fa-clock"></i></span><span class="nav-text">Availability</span></a></li>
                <li><a href="nurse_reports.html"><span class="nav-icon"><i class="fas fa-chart-bar"></i></span><span class="nav-text">Reports</span></a></li>
                <li><a href="nurse_scan.html" class="active"><span class="nav-icon"><i class="fas fa-qrcode"></i></span><span class="nav-text">QR Scanner</span></a></li>
                <li><a href="archive.html"><span class="nav-icon"><i class="fas fa-archive"></i></span><span class="nav-text">Archive</span></a></li>
                <li><a href="nurse_profile.html"><span class="nav-icon"><i class="fas fa-user"></i></span><span class="nav-text">Profile</span></a></li>
                <li><a href="#" id="logout"><span class="nav-icon"><i class="fas fa-sign-out-alt"></i></span><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
    </nav>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Main Content -->
    <main class="main-content">
        <div class="dashboard">
            <div class="dashboard-header">
                <h2>QR Code Scanner</h2>
                <p class="dashboard-subtitle">Scan student QR codes for quick access to medical information</p>
            </div>

            <!-- Scanner Interface -->
            <div class="scanner-container">
                <div class="scanner-section">
                    <div class="scanner-header">
                        <h3><i class="fas fa-qrcode"></i> Student QR Code Scanner</h3>
                        <p>Position the QR code within the camera frame for automatic detection</p>
                    </div>

                    <div class="scanner-viewport">
                        <div id="scanner" class="scanner-active">
                            <video id="video" autoplay playsinline></video>
                            <canvas id="canvas" style="display: none;"></canvas>
                            <div class="scanner-overlay">
                                <div class="scanner-frame">
                                    <div class="corner top-left"></div>
                                    <div class="corner top-right"></div>
                                    <div class="corner bottom-left"></div>
                                    <div class="corner bottom-right"></div>
                                </div>
                            </div>
                        </div>
                        <div class="scanner-placeholder" id="scannerPlaceholder" style="display: none;">
                            <div class="placeholder-content">
                                <i class="fas fa-camera"></i>
                                <p>Camera access required</p>
                                <button class="btn-primary" onclick="requestCameraAccess()">Enable Camera</button>
                            </div>
                        </div>
                    </div>

                    <div class="scanner-controls">
                        <button id="startScan" class="btn-primary">
                            <i class="fas fa-play"></i> Start Scanning
                        </button>
                        <button id="stopScan" class="btn-secondary" style="display: none;">
                            <i class="fas fa-stop"></i> Stop Scanning
                        </button>
                        <button id="toggleTorch" class="btn-secondary" style="display: none;">
                            <i class="fas fa-lightbulb"></i> Flashlight
                        </button>
                    </div>

                    <div class="scanner-info">
                        <div class="info-item">
                            <i class="fas fa-info-circle"></i>
                            <span>Ensure good lighting for better scanning</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-mobile-alt"></i>
                            <span>Hold device steady while scanning</span>
                        </div>
                    </div>
                </div>

                <!-- Scan Result -->
                <div class="scan-result" id="scanResult" style="display: none;">
                    <div class="result-header">
                        <h3><i class="fas fa-check-circle"></i> Scan Successful</h3>
                        <button class="btn-close" onclick="closeScanResult()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div id="studentInfo" class="student-card">
                        <!-- Student information will be displayed here -->
                    </div>

                    <div class="scan-actions">
                        <button id="viewRecord" class="btn-primary">
                            <i class="fas fa-file-medical"></i> View Medical Record
                        </button>
                        <button id="createAppointment" class="btn-primary">
                            <i class="fas fa-calendar-plus"></i> Create Appointment
                        </button>
                        <button id="quickCheckIn" class="btn-secondary">
                            <i class="fas fa-sign-in-alt"></i> Quick Check-in
                        </button>
                    </div>
                </div>

                <!-- Recent Scans -->
                <div class="recent-scans">
                    <h3><i class="fas fa-history"></i> Recent Scans</h3>
                    <div id="recentScansList" class="scans-list">
                        <!-- Recent scans will be displayed here -->
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; <span id="currentYear"></span> Clinic Management System. All rights reserved.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        // Sidebar toggle functionality
        document.getElementById('sidebarToggle').addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');

            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            } else {
                sidebar.classList.toggle('collapsed');
            }
        });

        document.getElementById('sidebarOverlay').addEventListener('click', function() {
            document.getElementById('sidebar').classList.remove('mobile-open');
            this.classList.remove('active');
        });

        // Set active nav item
        const currentPage = window.location.pathname.split('/').pop();
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        navLinks.forEach(link => {
            if (link.getAttribute('href') === currentPage) {
                link.classList.add('active');
            }
        });

        // Scanner variables
        let stream = null;
        let scanning = false;
        let scanInterval = null;
        let canvas = null;
        let video = null;

        // Initialize scanner
        document.addEventListener('DOMContentLoaded', function() {
            checkCameraSupport();
            loadRecentScans();
            canvas = document.getElementById('canvas');
            video = document.getElementById('video');
        });

        // Check camera support
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showCameraError('Camera not supported on this device');
                return;
            }
        }

        // Request camera access
        async function requestCameraAccess() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                document.getElementById('scanner').style.display = 'block';
                document.getElementById('scannerPlaceholder').style.display = 'none';
                document.getElementById('startScan').style.display = 'inline-block';

                // Check for flashlight support
                checkTorchSupport();

            } catch (error) {
                console.error('Camera access denied:', error);
                showCameraError('Camera access denied. Please allow camera access and try again.');
            }
        }

        // Check torch/flashlight support
        async function checkTorchSupport() {
            if (!stream) return;

            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (capabilities.torch) {
                document.getElementById('toggleTorch').style.display = 'inline-block';
            }
        }

        // Start scanning
        document.getElementById('startScan').addEventListener('click', function() {
            if (!stream) {
                requestCameraAccess().then(() => {
                    startScanning();
                });
            } else {
                startScanning();
            }
        });

        function startScanning() {
            scanning = true;
            document.getElementById('startScan').style.display = 'none';
            document.getElementById('stopScan').style.display = 'inline-block';
            document.getElementById('scanner').classList.add('scanning');

            // Start QR code detection
            scanQRCode();
        }

        // Stop scanning
        document.getElementById('stopScan').addEventListener('click', function() {
            stopScanning();
        });

        function stopScanning() {
            scanning = false;
            document.getElementById('startScan').style.display = 'inline-block';
            document.getElementById('stopScan').style.display = 'none';
            document.getElementById('scanner').classList.remove('scanning');

            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
        }

        // Toggle flashlight
        document.getElementById('toggleTorch').addEventListener('click', async function() {
            if (!stream) return;

            const track = stream.getVideoTracks()[0];
            const capabilities = track.getCapabilities();

            if (capabilities.torch) {
                try {
                    const currentTorch = track.getSettings().torch || false;
                    await track.applyConstraints({
                        advanced: [{ torch: !currentTorch }]
                    });

                    this.innerHTML = !currentTorch ?
                        '<i class="fas fa-lightbulb"></i> Turn Off Flash' :
                        '<i class="fas fa-lightbulb"></i> Flashlight';
                } catch (error) {
                    console.error('Torch control failed:', error);
                }
            }
        });

        // Scan QR code using jsQR
        function scanQRCode() {
            if (!scanning) return;

            const canvasContext = canvas.getContext('2d');

            function scanFrame() {
                if (!scanning || video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);

                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: 'dontInvert'
                });

                if (code) {
                    // QR code detected
                    processQRCode(code.data);
                    stopScanning();
                    return;
                }

                // Continue scanning
                if (scanning) {
                    requestAnimationFrame(scanFrame);
                }
            }

            scanFrame();
        }

        // Process detected QR code
        async function processQRCode(qrData) {
            try {
                // Send QR data to server for validation and processing
                const response = await fetch('/api/nurse/scan-appointment-qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({ qrData: qrData })
                });

                if (response.ok) {
                    const result = await response.json();
                    showScanResult(result.appointment, result.needsCheckIn, result.message);
                } else {
                    const error = await response.json();
                    alert('Scan failed: ' + error.message);
                }
            } catch (error) {
                console.error('Error processing QR code:', error);
                alert('Error processing QR code');
            }
        }

        // Show scan result
        function showScanResult(appointment, checkedIn, message) {
            const studentInfo = document.getElementById('studentInfo');
            const aptDate = appointment.appointmentDate ? new Date(appointment.appointmentDate).toLocaleString() : 'No appointment today';
            const statusClass = appointment.status ? `status-${appointment.status}` : 'status-none';
            const statusText = appointment.status || 'N/A';
            
            studentInfo.innerHTML = `
                <div class="student-avatar">
                    <i class="fas fa-user-circle"></i>
                </div>
                <div class="student-details">
                    <h4>${appointment.studentName}</h4>
                    <p class="student-id">Student ID: ${appointment.studentId}</p>
                    <p class="appointment-date">Appointment: ${aptDate}</p>
                    <p class="appointment-status">Status: <span class="${statusClass}">${statusText}</span></p>
                    <div class="student-status">
                        ${checkedIn ? 
                            '<span class="status-badge success">Check-in Successful</span>' : 
                            `<span class="status-badge warning">${message || 'Identification only'}</span>`
                        }
                    </div>
                </div>
            `;

            document.getElementById('scanResult').style.display = 'block';
            document.getElementById('scanResult').scrollIntoView({ behavior: 'smooth' });

            const studentInternalId = appointment.studentInternalId || appointment.student_id;

            // Set up button actions
            document.getElementById('viewRecord').onclick = () => {
                let url = `nurse_records.html?studentId=${studentInternalId}`;
                if (appointment.id) url += `&appointmentId=${appointment.id}`;
                window.location.href = url;
            };

            document.getElementById('createAppointment').onclick = () => {
                window.location.href = `nurse_appointments.html?studentId=${studentInternalId}&action=create`;
            };

            const quickCheckInBtn = document.getElementById('quickCheckIn');
            if (checkedIn) {
                quickCheckInBtn.classList.add('btn-disabled');
                quickCheckInBtn.innerHTML = '<i class="fas fa-check"></i> Checked-in';
                quickCheckInBtn.onclick = () => alert('Student is already checked in!');
            } else {
                quickCheckInBtn.classList.remove('btn-disabled');
                quickCheckInBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Quick Check-in';
                quickCheckInBtn.onclick = () => {
                    if (confirm('No appointment found for today. Would you like to create a walk-in appointment?')) {
                        window.location.href = `nurse_appointments.html?studentId=${studentInternalId}&action=walkin`;
                    }
                };
            }

            // Add to recent scans
            addToRecentScans(appointment.studentName, appointment.studentId);
        }

        // Close scan result
        function closeScanResult() {
            document.getElementById('scanResult').style.display = 'none';
        }

        // Load recent scans
        function loadRecentScans() {
            const recentList = document.getElementById('recentScansList');
            // Initialize empty or load from localStorage if needed
            recentList.innerHTML = '<p class="text-muted">No recent scans</p>';
        }

        // Add to recent scans
        function addToRecentScans(name, id) {
            const recentList = document.getElementById('recentScansList');
            const newScan = document.createElement('div');
            newScan.className = 'scan-item';
            newScan.innerHTML = `
                <div class="scan-info">
                    <span class="scan-name">${name}</span>
                    <span class="scan-time">Just now</span>
                </div>
                <button class="btn-small" onclick="rescan('${id}')">Rescan</button>
            `;

            // Insert at the beginning
            if (recentList.firstChild) {
                recentList.insertBefore(newScan, recentList.firstChild);
            } else {
                recentList.appendChild(newScan);
            }

            // Keep only last 5 scans
            while (recentList.children.length > 5) {
                recentList.removeChild(recentList.lastChild);
            }
        }

        // Rescan function
        function rescan(studentId) {
            // Implement rescan functionality
            alert(`Rescanning student ${studentId}`);
        }

        // Show camera error
        function showCameraError(message) {
            document.getElementById('scanner').style.display = 'none';
            document.getElementById('scannerPlaceholder').innerHTML = `
                <div class="placeholder-content">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>${message}</p>
                </div>
            `;
            document.getElementById('scannerPlaceholder').style.display = 'flex';
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            if (scanInterval) {
                clearInterval(scanInterval);
            }
        });
    </script>
</body>
</html>